<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>Spring-framework源码分析（七）bean的生命周期 - 代号十三</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="code-13,代号十三">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" type="image/x-icon" />
    <meta name="description" content="实例化填充属性初始化销毁">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring-framework源码分析（七）bean的生命周期">
<meta property="og:url" content="https://code-13.github.io/blogs/cf22b3ec.html">
<meta property="og:site_name" content="代号十三">
<meta property="og:description" content="实例化填充属性初始化销毁">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-07-29T03:54:09.000Z">
<meta property="article:modified_time" content="2021-12-24T09:12:03.509Z">
<meta property="article:author" content="代号十三">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="Spring-framework">
<meta name="twitter:card" content="summary">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1640337216968">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1640337216968">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/20200708225124.png)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="代号十三" class="mdui-btn mdui-btn-icon"><img src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" alt="代号十三"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="代号十三">
            <img src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" alt="代号十三" alt="代号十三">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>12</div>
        <div><span>标签</span>5</div>
        <div><span>分类</span>3</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="https://code-13.github.io/books" title="书海遨游">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                书海遨游
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:code-13.github.io" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/1504682" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/code-13/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JVM-内存分析/">JVM 内存分析</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/MapStruct/">MapStruct</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Spring-framework源码分析/">Spring-framework源码分析</a>
          <span class="category-list-count">9</span>
        </li>

        
      </ul>

    </div>
  </div>


    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/MAT/" style="font-size: 10px;">MAT</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/Spring-framework/" style="font-size: 20px;">Spring-framework</a> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 20px;">源码分析</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 代号十三
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br> 有点累
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 62.5%;"> 
              <img data-src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/2020/07/20/20200720195606.jpg" data-sizes="auto" alt="Spring-framework源码分析（七）bean的生命周期" class="lazyload">
              <h1>Spring-framework源码分析（七）bean的生命周期</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2020年07月29日</a>
    <a><i class="nexmoefont icon-areachart"></i>12.8k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 68 分钟</a>
</div>

      

      <p>实例化<br>填充属性<br>初始化<br>销毁</p>
<span id="more"></span>

<h1 id="getBean"><a href="#getBean" class="headerlink" title="getBean"></a>getBean</h1><p>getBean(String name)</p>
<h1 id="doGetBean"><a href="#doGetBean" class="headerlink" title="doGetBean()"></a>doGetBean()</h1><ul>
<li>name 就是bean名字</li>
<li>requiredType 表示需要的类型，如果有类型，创建后会进行类型转换</li>
<li>args 表示参数，也就是构造方法的参数</li>
<li>typeCheckOnly 表示只是做检查，并不是真的要用，这个会影响一些逻辑</li>
</ul>
<h2 id="doGetBean–1"><a href="#doGetBean–1" class="headerlink" title="doGetBean–1"></a>doGetBean–1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 转换 Bean 的名称</span><br>String beanName = transformedBeanName(name);<br>Object bean;<br><br><span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span><br><span class="hljs-comment">// 从已经实例化好的缓存中获取单例bean，因为我们此前可能已经将其实例化了</span><br>Object sharedInstance = getSingleton(beanName);<br><span class="hljs-comment">// 如果缓存中可以拿到，说明已经实例化过了</span><br><span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-keyword">null</span> &amp;&amp; args == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>    <span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +<br>          <span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>  &#125;<br>  bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>AbstractAutowireCapableBeanFactory</code>#<code>getObjectForBeanInstance</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getObjectForBeanInstance</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    Object beanInstance, String name, String beanName, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;<br><br>  <span class="hljs-comment">//如果有正在创建的bean要建立依赖关系</span><br><br>  String currentlyCreatedBean = <span class="hljs-keyword">this</span>.currentlyCreatedBean.get();<br>  <span class="hljs-keyword">if</span> (currentlyCreatedBean != <span class="hljs-keyword">null</span>) &#123;<br>    registerDependentBean(beanName, currentlyCreatedBean);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.getObjectForBeanInstance(beanInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>AbstractBeanFactory</code>#<code>getObjectForBeanInstance</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getObjectForBeanInstance</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">			Object beanInstance, String name, String beanName, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;<br><br>  <span class="hljs-comment">// Don&#x27;t let calling code try to dereference the factory if the bean isn&#x27;t a factory.</span><br>  <span class="hljs-comment">//是否是FactoryBean名字的前缀</span><br>  <span class="hljs-keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name)) &#123;<br>    <span class="hljs-keyword">if</span> (beanInstance <span class="hljs-keyword">instanceof</span> NullBean) &#123;<br>      <span class="hljs-keyword">return</span> beanInstance;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!(beanInstance <span class="hljs-keyword">instanceof</span> FactoryBean)) &#123;<br>      <span class="hljs-comment">//不是FactoryBean的话名字有&amp;会报异常</span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanIsNotAFactoryException(beanName, beanInstance.getClass());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (mbd != <span class="hljs-keyword">null</span>) &#123;<br>      mbd.isFactoryBean = <span class="hljs-keyword">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> beanInstance;<br>  &#125;<br><br>  <span class="hljs-comment">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span><br>  <span class="hljs-comment">// If it&#x27;s a FactoryBean, we use it to create a bean instance, unless the</span><br>  <span class="hljs-comment">// caller actually wants a reference to the factory.</span><br>  <span class="hljs-keyword">if</span> (!(beanInstance <span class="hljs-keyword">instanceof</span> FactoryBean)) &#123;<br>    <span class="hljs-comment">//不是FactoryBean就直接返回</span><br>    <span class="hljs-keyword">return</span> beanInstance;<br>  &#125;<br><br>  Object object = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">if</span> (mbd != <span class="hljs-keyword">null</span>) &#123;<br>    mbd.isFactoryBean = <span class="hljs-keyword">true</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//从FactoryBean的缓存中获取</span><br>    object = getCachedObjectForFactoryBean(beanName);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// Return bean instance from factory.</span><br>    FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;<br>    <span class="hljs-comment">// Caches object obtained from FactoryBean if it is a singleton.</span><br>    <span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> &amp;&amp; containsBeanDefinition(beanName)) &#123;<br>      mbd = getMergedLocalBeanDefinition(beanName);<br>    &#125;<br>    <span class="hljs-keyword">boolean</span> synthetic = (mbd != <span class="hljs-keyword">null</span> &amp;&amp; mbd.isSynthetic());<br>    object = getObjectFromFactoryBean(factory, beanName, !synthetic);<br>  &#125;<br>  <span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>getCachedObjectForFactoryBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getCachedObjectForFactoryBean</span><span class="hljs-params">(String beanName)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.factoryBeanObjectCache.get(beanName);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>FactoryBeanRegistrySupport#getObjectFromFactoryBean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getObjectFromFactoryBean</span><span class="hljs-params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="hljs-keyword">boolean</span> shouldPostProcess)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;<br>    <span class="hljs-keyword">synchronized</span> (getSingletonMutex()) &#123;<br>      Object object = <span class="hljs-keyword">this</span>.factoryBeanObjectCache.get(beanName);<br>      <span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;<br>        object = doGetObjectFromFactoryBean(factory, beanName);<br>        <span class="hljs-comment">// Only post-process and store if not put there already during getObject() call above</span><br>        <span class="hljs-comment">// (e.g. because of circular reference processing triggered by custom getBean calls)</span><br>        Object alreadyThere = <span class="hljs-keyword">this</span>.factoryBeanObjectCache.get(beanName);<br>        <span class="hljs-keyword">if</span> (alreadyThere != <span class="hljs-keyword">null</span>) &#123;<br>          object = alreadyThere;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">if</span> (shouldPostProcess) &#123;<br>            <span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>              <span class="hljs-comment">// Temporarily return non-post-processed object, not storing it yet..</span><br>              <span class="hljs-keyword">return</span> object;<br>            &#125;<br>            beforeSingletonCreation(beanName);<br>            <span class="hljs-keyword">try</span> &#123;<br>              <span class="hljs-comment">//进行后置处理器处理</span><br>              object = postProcessObjectFromFactoryBean(object, beanName);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,<br>                  <span class="hljs-string">&quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;</span>, ex);<br>            &#125;<br>            <span class="hljs-keyword">finally</span> &#123;<br>              afterSingletonCreation(beanName);<br>            &#125;<br>          &#125;<br>          <span class="hljs-keyword">if</span> (containsSingleton(beanName)) &#123;<br>            <span class="hljs-comment">//如果包含了FactoryBean，就将创建的对象缓存</span><br>            <span class="hljs-keyword">this</span>.factoryBeanObjectCache.put(beanName, object);<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> object;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//FactoryBean是原型的话</span><br>    Object object = doGetObjectFromFactoryBean(factory, beanName);<br>    <span class="hljs-keyword">if</span> (shouldPostProcess) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        object = postProcessObjectFromFactoryBean(object, beanName);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">&quot;Post-processing of FactoryBean&#x27;s object failed&quot;</span>, ex);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> object;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>doGetObjectFromFactoryBean</code></p>
<p>就是调用 <code>getObject()</code> 创建对象，如果返回null的话，就封装成一个 <code>NullBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">doGetObjectFromFactoryBean</span><span class="hljs-params">(FactoryBean&lt;?&gt; factory, String beanName)</span> <span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;<br>  Object object;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>      AccessControlContext acc = getAccessControlContext();<br>      <span class="hljs-keyword">try</span> &#123;<br>        object = AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) factory::getObject, acc);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (PrivilegedActionException pae) &#123;<br>        <span class="hljs-keyword">throw</span> pae.getException();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      object = factory.getObject();<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (FactoryBeanNotInitializedException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName, ex.toString());<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">&quot;FactoryBean threw exception on object creation&quot;</span>, ex);<br>  &#125;<br><br>  <span class="hljs-comment">// Do not accept a null value for a FactoryBean that&#x27;s not fully</span><br>  <span class="hljs-comment">// initialized yet: Many FactoryBeans just return null then.</span><br>  <span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(<br>          beanName, <span class="hljs-string">&quot;FactoryBean which is currently in creation returned null from getObject&quot;</span>);<br>    &#125;<br>    object = <span class="hljs-keyword">new</span> NullBean();<br>  &#125;<br>  <span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>beforeSingletonCreation</code> 和 <code>afterSingletonCreation</code></p>
<p>这个就是标记下，正在创建这个bean，创建处理完了就清除标记。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeSingletonCreation</span><span class="hljs-params">(String beanName)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.inCreationCheckExclusions.contains(beanName) &amp;&amp; !<span class="hljs-keyword">this</span>.singletonsCurrentlyInCreation.add(beanName)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName);<span class="hljs-comment">//没有在排除范围里内且添加不成功，可能就是循环引用了</span><br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterSingletonCreation</span><span class="hljs-params">(String beanName)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.inCreationCheckExclusions.contains(beanName) &amp;&amp; !<span class="hljs-keyword">this</span>.singletonsCurrentlyInCreation.remove(beanName)) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Singleton &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; isn&#x27;t currently in creation&quot;</span>);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>postProcessObjectFromFactoryBean</code></p>
<p>就是进行 <code>BeanPostProcessor</code> 的 <code>postProcessAfterInitialization</code> 处理，也就是可以扩展的地方。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">postProcessObjectFromFactoryBean</span><span class="hljs-params">(Object object, String beanName)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> applyBeanPostProcessorsAfterInitialization(object, beanName);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">applyBeanPostProcessorsAfterInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br><br>  Object result = existingBean;<br>  <span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;<br>    Object current = processor.postProcessAfterInitialization(result, beanName);<br>    <span class="hljs-keyword">if</span> (current == <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    result = current;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="doGetBean–2"><a href="#doGetBean–2" class="headerlink" title="doGetBean–2"></a>doGetBean–2</h2><ul>
<li>判断是不是正在创建的原型类型，原型类型无法解决循环应用问题，会报异常。</li>
<li>原型的定义就是每次都是需要新的对象，如果A是原型，引用B，这个时候B也是要被创建的，如果B是原型，也引用A，那A也要被重新创建，然后A里面又要引用B，又重新创建，这样下去就变成创建的死循环了，所以原型循环引用不行</li>
<li>如果发现父工厂存在， <code>bean</code> 定义不存在，就会从父工厂去找，让父工厂去创建。这种情况比较少</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Fail if we&#x27;re already creating this bean instance:</span><br><span class="hljs-comment">// We&#x27;re assumably within a circular reference.</span><br><span class="hljs-comment">//原型的循环引用报错</span><br><span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName);<br>&#125;<br><br><span class="hljs-comment">// Check if bean definition exists in this factory. 如果bean定义不存在，就检查父工厂是否有</span><br>BeanFactory parentBeanFactory = getParentBeanFactory();<br><span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;<br>  <span class="hljs-comment">// Not found -&gt; check parent.</span><br>  String nameToLookup = originalBeanName(name);<br>  <span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;<br>    <span class="hljs-keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(<br>        nameToLookup, requiredType, args, typeCheckOnly);<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// Delegation to parent with explicit args.</span><br>    <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span><br>    <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="doGetBean–3"><a href="#doGetBean–3" class="headerlink" title="doGetBean–3"></a>doGetBean–3</h2><ul>
<li>先判断是否仅仅是检查类型，不是就标记为已经创建，并设置需要 bean 定义合并标记</li>
<li>处理 <code>dependsOn</code> 依赖</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br>  <span class="hljs-comment">// 将Bean标记为已经创建</span><br>  markBeanAsCreated(beanName);<br>&#125;<br><br><span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-comment">// 获取合并过的BeanDefinition, BeanDefinition.getParentName如果不为null，需要先获取，然后合并BeanDefinition</span><br>  RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);<br>  <span class="hljs-comment">// 检查合并过的BeanDefinition</span><br>  checkMergedBeanDefinition(mbd, beanName, args);<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 先查看 bean 有没有依赖项，有就先创建依赖项</span><br><span class="hljs-comment">    */</span><br>  <span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span><br>  String[] dependsOn = mbd.getDependsOn();<br>  <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;<br>      <span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,<br>            <span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      registerDependentBean(dep, beanName);<br>      <span class="hljs-keyword">try</span> &#123;<br>        getBean(dep);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,<br>            <span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>markBeanAsCreated</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">markBeanAsCreated</span><span class="hljs-params">(String beanName)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.alreadyCreated.contains(beanName)) &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.mergedBeanDefinitions) &#123;<br>      <span class="hljs-comment">//需要重新获取合并一下bean定义，以免元数据被同时修改</span><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.alreadyCreated.contains(beanName)) &#123;<br>        <span class="hljs-comment">// Let the bean definition get re-merged now that we&#x27;re actually creating</span><br>        <span class="hljs-comment">// the bean... just in case some of its metadata changed in the meantime.</span><br>        clearMergedBeanDefinition(beanName);<br>        <span class="hljs-keyword">this</span>.alreadyCreated.add(beanName);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearMergedBeanDefinition</span><span class="hljs-params">(String beanName)</span> </span>&#123;<br>  RootBeanDefinition bd = <span class="hljs-keyword">this</span>.mergedBeanDefinitions.get(beanName);<br>  <span class="hljs-keyword">if</span> (bd != <span class="hljs-keyword">null</span>) &#123;<br>    bd.stale = <span class="hljs-keyword">true</span>;<span class="hljs-comment">//需要合并</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="doGetBean–4"><a href="#doGetBean–4" class="headerlink" title="doGetBean–4"></a>doGetBean–4</h2><p>下面就是 <code>Bean</code> 的创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Create bean instance.</span><br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>  <span class="hljs-comment">// 单例创建</span><br>  sharedInstance = getSingleton(beanName, () -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>      <span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br>      <span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br>      <span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>      destroySingleton(beanName);<br>      <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>  &#125;);<br>  bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;<br>  Assert.notNull(beanName, <span class="hljs-string">&quot;Bean name must not be null&quot;</span>);<br>  <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;<br><br>    <span class="hljs-comment">// singletonObjects 就是缓存的已经创建好的单例bean</span><br>    <span class="hljs-comment">// 如果缓存中有，就直接返回；没有再创建</span><br><br>    Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);<br><br>    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.singletonsCurrentlyInDestruction) &#123;<br>        <span class="hljs-comment">// 如果bean已经被销毁，就抛出异常</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationNotAllowedException(beanName,<br>            <span class="hljs-string">&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot;</span> +<br>            <span class="hljs-string">&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>        logger.debug(<span class="hljs-string">&quot;Creating shared instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      <span class="hljs-comment">// 创建前做一个正在创建的标记</span><br>      beforeSingletonCreation(beanName);<br>      <span class="hljs-comment">// 是否创建单例成功，感觉这个用处不大</span><br>      <span class="hljs-keyword">boolean</span> newSingleton = <span class="hljs-keyword">false</span>;<br>      <span class="hljs-keyword">boolean</span> recordSuppressedExceptions = (<span class="hljs-keyword">this</span>.suppressedExceptions == <span class="hljs-keyword">null</span>);<br>      <span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br>        <span class="hljs-keyword">this</span>.suppressedExceptions = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//调用ObjectFactory的getObject创建bean对象</span><br>        singletonObject = singletonFactory.getObject();<br>        <span class="hljs-comment">//只要获取了就是新单例</span><br>        newSingleton = <span class="hljs-keyword">true</span>;<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br>        <span class="hljs-comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span><br>        <span class="hljs-comment">// if yes, proceed with it since the exception indicates that state.</span><br>        singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);<br>        <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> ex;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br>        <span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br>          <span class="hljs-keyword">for</span> (Exception suppressedException : <span class="hljs-keyword">this</span>.suppressedExceptions) &#123;<br>            ex.addRelatedCause(suppressedException);<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">throw</span> ex;<br>      &#125;<br>      <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br>          <span class="hljs-keyword">this</span>.suppressedExceptions = <span class="hljs-keyword">null</span>;<br>        &#125;<br>        afterSingletonCreation(beanName);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (newSingleton) &#123;<br>        <span class="hljs-comment">//如果是新的单例，就加入到单例集合</span><br>        addSingleton(beanName, singletonObject);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> singletonObject;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</code></p>
<ul>
<li>解析类型</li>
<li>进行方法覆盖</li>
<li><code>InstantiationAwareBeanPostProcessor</code> 处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">createBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;<br><br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>    logger.trace(<span class="hljs-string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>  &#125;<br>  RootBeanDefinition mbdToUse = mbd;<br><br>  <span class="hljs-comment">// Make sure bean class is actually resolved at this point, and</span><br>  <span class="hljs-comment">// clone the bean definition in case of a dynamically resolved Class</span><br>  <span class="hljs-comment">// which cannot be stored in the shared merged bean definition.</span><br><br>  <span class="hljs-comment">//解析出bean的类型 ； 很复杂</span><br>  Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);<br><br>  <span class="hljs-comment">//能解析出来，没有BeanClass只有BeanClassName</span><br>  <span class="hljs-keyword">if</span> (resolvedClass != <span class="hljs-keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">//重新创建RootBeanDefinition</span><br>    mbdToUse = <span class="hljs-keyword">new</span> RootBeanDefinition(mbd);<br>    <span class="hljs-comment">//设置解析的类型</span><br>    mbdToUse.setBeanClass(resolvedClass);<br>  &#125;<br><br>  <span class="hljs-comment">// Prepare method overrides.</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//准备方法覆盖，处理look-up方法</span><br>    mbdToUse.prepareMethodOverrides();<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(mbdToUse.getResourceDescription(),<br>        beanName, <span class="hljs-string">&quot;Validation of method overrides failed&quot;</span>, ex);<br>  &#125;<br><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span><br><br>    <span class="hljs-comment">//后置处理器在实例化之前处理，如果返回不为null，直接就返回了</span><br>    <span class="hljs-comment">// 此时的后置处理器是 InstantiationAwareBeanPostProcessor</span><br><br>    Object bean = resolveBeforeInstantiation(beanName, mbdToUse);<br>    <span class="hljs-keyword">if</span> (bean != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName,<br>        <span class="hljs-string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);<br>  &#125;<br><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//真正创建 bean</span><br>    Object beanInstance = doCreateBean(beanName, mbdToUse, args);<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> beanInstance;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;<br>    <span class="hljs-comment">// A previously detected exception with proper bean creation context already,</span><br>    <span class="hljs-comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><br>    <span class="hljs-keyword">throw</span> ex;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(<br>        mbdToUse.getResourceDescription(), beanName, <span class="hljs-string">&quot;Unexpected exception during bean creation&quot;</span>, ex);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>resolveBeforeInstantiation</code> 实例化前处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">resolveBeforeInstantiation</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd)</span> </span>&#123;<br>  Object bean = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">if</span> (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123;<br>    <span class="hljs-comment">// Make sure bean class is actually resolved at this point.</span><br>    <span class="hljs-comment">// 非合成的，且有 InstantiationAwareBeanPostProcessors</span><br>    <span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br>      Class&lt;?&gt; targetType = determineTargetType(beanName, mbd);<br>      <span class="hljs-keyword">if</span> (targetType != <span class="hljs-keyword">null</span>) &#123;<br>        bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);<br>        <span class="hljs-keyword">if</span> (bean != <span class="hljs-keyword">null</span>) &#123;<br>          bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);<br>        &#125;<br>      &#125;<br>    &#125;<br>    mbd.beforeInstantiationResolved = (bean != <span class="hljs-keyword">null</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>applyBeanPostProcessorsBeforeInstantiation</code> 实例化前处理器处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">applyBeanPostProcessorsBeforeInstantiation</span><span class="hljs-params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;<br>    Object result = bp.postProcessBeforeInstantiation(beanClass, beanName);<br>    <span class="hljs-keyword">if</span> (result != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>applyBeanPostProcessorsAfterInitialization</code> 初始化后处理器处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">applyBeanPostProcessorsAfterInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br><br>  Object result = existingBean;<br>  <span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;<br>    Object current = processor.postProcessAfterInitialization(result, beanName);<br>    <span class="hljs-keyword">if</span> (current == <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    result = current;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>InstantiationAwareBeanPostProcessor 拓展点</p>
<ul>
<li>不论前还是后只要返回就不会再创建</li>
</ul>
<h2 id="doCreateBean"><a href="#doCreateBean" class="headerlink" title="doCreateBean"></a>doCreateBean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;<br><br>  <span class="hljs-comment">// Instantiate the bean.</span><br>  BeanWrapper instanceWrapper = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>    <span class="hljs-comment">//获取 factoryBean 实例缓存</span><br>    instanceWrapper = <span class="hljs-keyword">this</span>.factoryBeanInstanceCache.remove(beanName);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// 没有 factoryBean 就创建</span><br>    instanceWrapper = createBeanInstance(beanName, mbd, args);<br>  &#125;<br>  <span class="hljs-comment">// 获取原始 bean</span><br>  Object bean = instanceWrapper.getWrappedInstance();<br>  Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br><br>  <span class="hljs-comment">//不为空的bean</span><br>  <span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>    mbd.resolvedTargetType = beanType;<br>  &#125;<br><br>  <span class="hljs-comment">// 处理器修改合并的 BeanDefinition 定义</span><br>  <span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span><br>  <span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br>    <span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,<br>            <span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>      &#125;<br>      mbd.postProcessed = <span class="hljs-keyword">true</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 提前暴露一个早期的单例工厂，以便解决循环引用</span><br><br>  <span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span><br>  <span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br>  <span class="hljs-keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.allowCircularReferences &amp;&amp;<br>      isSingletonCurrentlyInCreation(beanName));<br>  <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br>          <span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>    &#125;<br>    addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>  &#125;<br><br>  <span class="hljs-comment">// 初始化阶段</span><br><br>  <span class="hljs-comment">// Initialize the bean instance.</span><br>  Object exposedObject = bean;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 属性填充</span><br>    populateBean(beanName, mbd, instanceWrapper);<br>    <span class="hljs-comment">// 初始化</span><br>    exposedObject = initializeBean(beanName, exposedObject, mbd);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;<br>      <span class="hljs-keyword">throw</span> (BeanCreationException) ex;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(<br>          mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Initialization of bean failed&quot;</span>, ex);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>    Object earlySingletonReference = getSingleton(beanName, <span class="hljs-keyword">false</span>);<br>    <span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>        exposedObject = earlySingletonReference;<br>      &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;<br>        String[] dependentBeans = getDependentBeans(beanName);<br>        Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);<br>        <span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;<br>          <span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>            actualDependentBeans.add(dependentBean);<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName,<br>              <span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> +<br>              StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +<br>              <span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +<br>              <span class="hljs-string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +<br>              <span class="hljs-string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +<br>              <span class="hljs-string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Register bean as disposable.</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//注册可销毁的bean</span><br>    registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(<br>        mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="createBeanInstance-创建-bean-实例"><a href="#createBeanInstance-创建-bean-实例" class="headerlink" title="createBeanInstance 创建 bean 实例"></a><code>createBeanInstance</code> 创建 <code>bean</code> 实例</h3><ul>
<li>获取类型</li>
<li>获取修饰符，只有 public 才允许创建</li>
<li>获取自定义的实例提供器，如果有的话直接获取返回</li>
<li>如果有工厂方法名字，使用工厂方法创建</li>
<li>推断构造函数<ul>
<li>找出合适的构造函数进行自动装配</li>
</ul>
</li>
<li>以上都不行，使用默认的无参构造函数进行实例化</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title">createBeanInstance</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> </span>&#123;<br>  <span class="hljs-comment">// Make sure bean class is actually resolved at this point.</span><br>  <span class="hljs-comment">// 获取类型</span><br>  Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);<br><br>  <span class="hljs-comment">// 检查类 是不是 public 修饰的</span><br>  <span class="hljs-keyword">if</span> (beanClass != <span class="hljs-keyword">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,<br>        <span class="hljs-string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());<br>  &#125;<br><br>  <span class="hljs-comment">// 如果 mbd 有拓展的实例提供器，可以直接从里面获取实例</span><br>  Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();<br>  <span class="hljs-keyword">if</span> (instanceSupplier != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);<br>  &#125;<br><br>  <span class="hljs-comment">// 有工厂方法的，从工厂方法获取</span><br>  <span class="hljs-keyword">if</span> (mbd.getFactoryMethodName() != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);<br>  &#125;<br><br>  <span class="hljs-comment">// Shortcut when re-creating the same bean...</span><br>  <span class="hljs-comment">//标记下，防止重复创建同一个bean</span><br>  <span class="hljs-keyword">boolean</span> resolved = <span class="hljs-keyword">false</span>;<br>  <span class="hljs-comment">//是否需要自动装配，构造器有参数的需要</span><br>  <span class="hljs-keyword">boolean</span> autowireNecessary = <span class="hljs-keyword">false</span>;<br>  <span class="hljs-keyword">if</span> (args == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// 无参</span><br>    <span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br>      <span class="hljs-keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">//有解析的构造器或者工厂方法</span><br>        resolved = <span class="hljs-keyword">true</span>;<br>        autowireNecessary = mbd.constructorArgumentsResolved;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">//有构造参数的或者工厂方法</span><br>  <span class="hljs-keyword">if</span> (resolved) &#123;<br>    <span class="hljs-comment">//构造器有参数的</span><br>    <span class="hljs-keyword">if</span> (autowireNecessary) &#123;<br>      <span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//从bean后置处理器中为自动装配寻找构造方法</span><br>  <span class="hljs-comment">// Candidate constructors for autowiring?</span><br>  Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);<br>  <span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||<br>      mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;<br>    <span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);<br>  &#125;<br><br>  <span class="hljs-comment">// 找出最合适的默认构造方法</span><br>  <span class="hljs-comment">// Preferred constructors for default construction?</span><br>  ctors = mbd.getPreferredConstructors();<br>  <span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="hljs-keyword">null</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 最后才用最简单的默认构造方法</span><br>  <span class="hljs-comment">// No special handling: simply use no-arg constructor.</span><br>  <span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="obtainFromSupplier-实例提供器"><a href="#obtainFromSupplier-实例提供器" class="headerlink" title="obtainFromSupplier 实例提供器"></a>obtainFromSupplier 实例提供器</h4><p>这是又一个拓展点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title">obtainFromSupplier</span><span class="hljs-params">(Supplier&lt;?&gt; instanceSupplier, String beanName)</span> </span>&#123;<br>  Object instance;<br><br>  String outerBean = <span class="hljs-keyword">this</span>.currentlyCreatedBean.get();<br>  <span class="hljs-keyword">this</span>.currentlyCreatedBean.set(beanName);<br>  <span class="hljs-keyword">try</span> &#123;<br>    instance = instanceSupplier.get();<br>  &#125;<br>  <span class="hljs-keyword">finally</span> &#123;<br>    <span class="hljs-keyword">if</span> (outerBean != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-comment">// 不为空还是这是老的</span><br>      <span class="hljs-keyword">this</span>.currentlyCreatedBean.set(outerBean);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 为空删除</span><br>      <span class="hljs-keyword">this</span>.currentlyCreatedBean.remove();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (instance == <span class="hljs-keyword">null</span>) &#123;<br>    instance = <span class="hljs-keyword">new</span> NullBean();<br>  &#125;<br>  BeanWrapper bw = <span class="hljs-keyword">new</span> BeanWrapperImpl(instance);<br>  initBeanWrapper(bw);<br>  <span class="hljs-keyword">return</span> bw;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="instantiateUsingFactoryMethod-工厂方法实例化"><a href="#instantiateUsingFactoryMethod-工厂方法实例化" class="headerlink" title="instantiateUsingFactoryMethod 工厂方法实例化"></a>instantiateUsingFactoryMethod 工厂方法实例化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title">instantiateUsingFactoryMethod</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] explicitArgs)</span> </span>&#123;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConstructorResolver(<span class="hljs-keyword">this</span>).instantiateUsingFactoryMethod(beanName, mbd, explicitArgs);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ConstructorResolver</p>
<p>保存 BeanFactory ，然后利用 BeanFactory 来做一些事情</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstructorResolver</span><span class="hljs-params">(AbstractAutowireCapableBeanFactory beanFactory)</span> </span>&#123;<br>  <span class="hljs-keyword">this</span>.beanFactory = beanFactory;<br>  <span class="hljs-keyword">this</span>.logger = beanFactory.getLogger();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>instantiateUsingFactoryMethod</p>
<ul>
<li>根据工厂方法的是不是唯一来进行创建,如果唯一，就直接创建，不唯一的话还要进行方法获取，然后选出工厂方法，再处理</li>
</ul>
<p>instantiateUsingFactoryMethod–1</p>
<ul>
<li>创建一个实例持有器,后从 RootBeanDefinition中 获取 factoryBeanName，也就是工厂方法，比如说 bean 注解的方法就是</li>
<li>如果存在判断下是不是要创建自身，会报错，创建自身等于无限循环创建了</li>
<li>如果不是的话就获取factoryBean即工厂实例，获取工厂类型，设置非静态的。如果获取不到工厂实例，说明是静态方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//实例持有器</span><br>BeanWrapperImpl bw = <span class="hljs-keyword">new</span> BeanWrapperImpl();<br><span class="hljs-keyword">this</span>.beanFactory.initBeanWrapper(bw);<br><br><span class="hljs-comment">//工厂实例</span><br>Object factoryBean;<br><span class="hljs-comment">//工厂类型</span><br>Class&lt;?&gt; factoryClass;<br><span class="hljs-comment">//是否是静态的,存在factoryBeanName表示是实例工厂，非静态方法，否则是静态的</span><br><span class="hljs-keyword">boolean</span> isStatic;<br><br><span class="hljs-comment">//factoryBeanName，也就是工厂方法所属的类的简单名字，比如配置类，这里的factoryBean，不是FactoryBean接口</span><br>String factoryBeanName = mbd.getFactoryBeanName();<br><br><span class="hljs-keyword">if</span> (factoryBeanName != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">if</span> (factoryBeanName.equals(beanName)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(mbd.getResourceDescription(), beanName,<br>        <span class="hljs-string">&quot;factory-bean reference points back to the same bean definition&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">//获得通过工厂获取 factoryBean</span><br>  factoryBean = <span class="hljs-keyword">this</span>.beanFactory.getBean(factoryBeanName);<br>  <span class="hljs-comment">//已经创建了</span><br>  <span class="hljs-keyword">if</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.beanFactory.containsSingleton(beanName)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ImplicitlyAppearedSingletonException();<br>  &#125;<br>  factoryClass = factoryBean.getClass();<br>  isStatic = <span class="hljs-keyword">false</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">//静态的方法，无factoryBean实例</span><br>  <span class="hljs-comment">// It&#x27;s a static factory method on the bean class.</span><br>  <span class="hljs-keyword">if</span> (!mbd.hasBeanClass()) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(mbd.getResourceDescription(), beanName,<br>        <span class="hljs-string">&quot;bean definition declares neither a bean class nor a factory-bean reference&quot;</span>);<br>  &#125;<br>  factoryBean = <span class="hljs-keyword">null</span>;<br>  factoryClass = mbd.getBeanClass();<br>  isStatic = <span class="hljs-keyword">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>instantiateUsingFactoryMethod–2</p>
<p>准备好参数，尝试获取已经解析的数据，第一次都是空的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//准备使用的工厂方法</span><br>Method factoryMethodToUse = <span class="hljs-keyword">null</span>;<br><span class="hljs-comment">//准备使用的参数包装器</span><br>ArgumentsHolder argsHolderToUse = <span class="hljs-keyword">null</span>;<br><span class="hljs-comment">//准备使用的参数</span><br>Object[] argsToUse = <span class="hljs-keyword">null</span>;<br><br><span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-comment">//如果有显示参数就使用这些参数</span><br>  argsToUse = explicitArgs;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">//解析出的参数</span><br>  Object[] argsToResolve = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br>    factoryMethodToUse = (Method) mbd.resolvedConstructorOrFactoryMethod;<br>    <span class="hljs-comment">//如果有工厂方法，且构造函数已经解析了</span><br>    <span class="hljs-keyword">if</span> (factoryMethodToUse != <span class="hljs-keyword">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;<br>      <span class="hljs-comment">// Found a cached factory method...</span><br>      argsToUse = mbd.resolvedConstructorArguments;<br>      <span class="hljs-keyword">if</span> (argsToUse == <span class="hljs-keyword">null</span>) &#123;<br>        argsToResolve = mbd.preparedConstructorArguments;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (argsToResolve != <span class="hljs-keyword">null</span>) &#123;<br>    argsToUse = resolvePreparedArguments(beanName, mbd, bw, factoryMethodToUse, argsToResolve, <span class="hljs-keyword">true</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>instantiateUsingFactoryMethod–3</p>
<ul>
<li>如果没解析过，就获取factoryClass的用户定义类型，因为此时factoryClass可能是CGLIB动态代理类型，所以要获取用父类的类型。</li>
<li>如果工厂方法是唯一的，就是没重载的，就获取解析的工厂方法，如果不为空，就添加到一个不可变列表里，如果为空的话，就要去找出factoryClass的以及父类的所有的方法，进一步找出方法修饰符一致且名字跟工厂方法名字相同的且是bean注解的方法，并放入列表里。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (factoryMethodToUse == <span class="hljs-keyword">null</span> || argsToUse == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-comment">// Need to determine the factory method...</span><br>  <span class="hljs-comment">// Try all methods with this name to see if they match the given arguments.</span><br><br>  <span class="hljs-comment">//获取用户定义的类</span><br>  factoryClass = ClassUtils.getUserClass(factoryClass);<br><br>  <span class="hljs-comment">//方法集合</span><br>  List&lt;Method&gt; candidates = <span class="hljs-keyword">null</span>;<br><br>  <span class="hljs-comment">//如果工厂方法唯一，没重载的</span><br>  <span class="hljs-keyword">if</span> (mbd.isFactoryMethodUnique) &#123;<br>    <span class="hljs-keyword">if</span> (factoryMethodToUse == <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-comment">//获取解析的工厂方法</span><br>      factoryMethodToUse = mbd.getResolvedFactoryMethod();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (factoryMethodToUse != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-comment">//存在的话，返回仅包含factoryMethodToUse的不可变列表</span><br>      candidates = Collections.singletonList(factoryMethodToUse);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">//如果没找到工厂方法，可能有重载</span><br>  <span class="hljs-keyword">if</span> (candidates == <span class="hljs-keyword">null</span>) &#123;<br>    candidates = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-comment">//获取factoryClass以及父类的所有方法作为候选的方法</span><br>    Method[] rawCandidates = getCandidateMethods(factoryClass, mbd);<br>    <span class="hljs-comment">//过滤出修饰符一样，工厂方法名一样且是bean注解的方法</span><br>    <span class="hljs-keyword">for</span> (Method candidate : rawCandidates) &#123;<br>      <span class="hljs-keyword">if</span> (Modifier.isStatic(candidate.getModifiers()) == isStatic &amp;&amp; mbd.isFactoryMethod(candidate)) &#123;<br>        <span class="hljs-comment">//如果isStatic修饰符一样且名字跟工厂方法名一样就添加</span><br>        candidates.add(candidate);<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>ClassUtils.getUserClass 找出用户定义的类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getUserClass(Class&lt;?&gt; clazz) &#123;<br>  <span class="hljs-comment">//如果包含CGLIB的名字符号，尝试获取父类</span><br>  <span class="hljs-keyword">if</span> (clazz.getName().contains(CGLIB_CLASS_SEPARATOR)) &#123;<br>    Class&lt;?&gt; superclass = clazz.getSuperclass();<br>    <span class="hljs-keyword">if</span> (superclass != <span class="hljs-keyword">null</span> &amp;&amp; superclass != Object.class) &#123;<br>      <span class="hljs-keyword">return</span> superclass;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> clazz;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>getCandidateMethods 获取所有候选方法包括父类的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Method[] getCandidateMethods(Class&lt;?&gt; factoryClass, RootBeanDefinition mbd) &#123;<br>  <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> AccessController.doPrivileged((PrivilegedAction&lt;Method[]&gt;) () -&gt;<br>        (mbd.isNonPublicAccessAllowed() ?<br>          ReflectionUtils.getAllDeclaredMethods(factoryClass) : factoryClass.getMethods()));<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//如果允许非Public的方法，就获取所有申明的方法，包括父类的，否则就是Public的方法，包括父类的，默认是允许的</span><br>    <span class="hljs-keyword">return</span> (mbd.isNonPublicAccessAllowed() ?<br>        ReflectionUtils.getAllDeclaredMethods(factoryClass) : factoryClass.getMethods());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ReflectionUtils.getAllDeclaredMethods 用反射获取方法</p>
<p>如果允许非Public的方法，就获取所有申明的方法，包括父类的，否则就是Public的方法，包括父类的，默认是允许的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Method[] getAllDeclaredMethods(Class&lt;?&gt; leafClass) &#123;<br>  <span class="hljs-keyword">final</span> List&lt;Method&gt; methods = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-number">32</span>);<br>  doWithMethods(leafClass, methods::add);<br>  <span class="hljs-keyword">return</span> methods.toArray(EMPTY_METHOD_ARRAY);<br>&#125;<br><br>...<span class="hljs-comment">//省略其余代码</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doWithMethods</span><span class="hljs-params">(Class&lt;?&gt; clazz, MethodCallback mc)</span> </span>&#123;<br>  doWithMethods(clazz, mc, <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>doWithMethods 递归获取</p>
<p>递归获取所有的方法以及父类的，获取后执行mc.doWith(method)方法，其实就是上面的methods::add把方法添加到列表里，最后转换成数组返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doWithMethods</span><span class="hljs-params">(Class&lt;?&gt; clazz, MethodCallback mc, <span class="hljs-meta">@Nullable</span> MethodFilter mf)</span> </span>&#123;<br>  <span class="hljs-comment">// Keep backing up the inheritance hierarchy.</span><br>  Method[] methods = getDeclaredMethods(clazz, <span class="hljs-keyword">false</span>);<br>  <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>    <span class="hljs-keyword">if</span> (mf != <span class="hljs-keyword">null</span> &amp;&amp; !mf.matches(method)) &#123;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      mc.doWith(method);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Not allowed to access method &#x27;&quot;</span> + method.getName() + <span class="hljs-string">&quot;&#x27;: &quot;</span> + ex);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span> &amp;&amp; (mf != USER_DECLARED_METHODS || clazz.getSuperclass() != Object.class)) &#123;<br>    doWithMethods(clazz.getSuperclass(), mc, mf);<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz.isInterface()) &#123;<br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; superIfc : clazz.getInterfaces()) &#123;<br>      doWithMethods(superIfc, mc, mf);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>instantiateUsingFactoryMethod–4</p>
<p>只有一个无参工厂方法<br>如果只有一个构造函数的话，看是否有参数，没有的话直接就设置bean定义的属性，然后实例化设置进包装对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//如果只获取到一个方法，且传入的参数为空，且没有设置构造方法参数值</span><br><span class="hljs-keyword">if</span> (candidates.size() == <span class="hljs-number">1</span> &amp;&amp; explicitArgs == <span class="hljs-keyword">null</span> &amp;&amp; !mbd.hasConstructorArgumentValues()) &#123;<br>  <span class="hljs-comment">//获取出来</span><br>  Method uniqueCandidate = candidates.get(<span class="hljs-number">0</span>);<br>  <span class="hljs-comment">//没参数的话</span><br>  <span class="hljs-keyword">if</span> (uniqueCandidate.getParameterCount() == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//设置工厂方法</span><br>    mbd.factoryMethodToIntrospect = uniqueCandidate;<br>    <span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br>      <span class="hljs-comment">//设置解析出来的方法</span><br>      mbd.resolvedConstructorOrFactoryMethod = uniqueCandidate;<br>      <span class="hljs-comment">//参数也已经解析了</span><br>      mbd.constructorArgumentsResolved = <span class="hljs-keyword">true</span>;<br>      <span class="hljs-comment">//方法参数为空</span><br>      mbd.resolvedConstructorArguments = EMPTY_ARGS;<br>    &#125;<br>    <span class="hljs-comment">//创建实例并设置到持有器里</span><br>    bw.setBeanInstance(instantiate(beanName, mbd, factoryBean, uniqueCandidate, EMPTY_ARGS));<br>    <span class="hljs-keyword">return</span> bw;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>instantiate 工厂方法实例化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">instantiate</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd,</span></span><br><span class="hljs-params"><span class="hljs-function">			<span class="hljs-meta">@Nullable</span> Object factoryBean, Method factoryMethod, Object[] args)</span> </span>&#123;<br><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt;<br>          <span class="hljs-keyword">this</span>.beanFactory.getInstantiationStrategy().instantiate(<br>              mbd, beanName, <span class="hljs-keyword">this</span>.beanFactory, factoryBean, factoryMethod, args),<br>          <span class="hljs-keyword">this</span>.beanFactory.getAccessControlContext());<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//获取实例化策略进行实例化</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.beanFactory.getInstantiationStrategy().instantiate(<br>          mbd, beanName, <span class="hljs-keyword">this</span>.beanFactory, factoryBean, factoryMethod, args);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,<br>        <span class="hljs-string">&quot;Bean instantiation via factory method failed&quot;</span>, ex);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>SimpleInstantiationStrategy#instantiate</p>
<p>其实默认的实例化策略是CglibSubclassingInstantiationStrategy，就是可以用CGLIB做动态代理，但是仅限于方法注入的形式，所以这里是无参工厂方法还是调用父类SimpleInstantiationStrategy的实现。其实就是调用工厂实例的工厂方法，传入参数，只是参数是个空数组EMPTY_ARGS，返回对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">instantiate</span><span class="hljs-params">(RootBeanDefinition bd, <span class="hljs-meta">@Nullable</span> String beanName, BeanFactory owner,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-meta">@Nullable</span> Object factoryBean, <span class="hljs-keyword">final</span> Method factoryMethod, Object... args)</span> </span>&#123;<br><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>      AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>        ReflectionUtils.makeAccessible(factoryMethod);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>      &#125;);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//设置 factoryMethod 可访问</span><br>      ReflectionUtils.makeAccessible(factoryMethod);<br>    &#125;<br><br>    <span class="hljs-comment">//获取前面存在的线程本地的FactoryMethod</span><br>    Method priorInvokedFactoryMethod = currentlyInvokedFactoryMethod.get();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//设置新的</span><br>      currentlyInvokedFactoryMethod.set(factoryMethod);<br>      <span class="hljs-comment">//调用工厂方法</span><br>      Object result = factoryMethod.invoke(factoryBean, args);<br>      <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span>) &#123;<br>        result = <span class="hljs-keyword">new</span> NullBean();<br>      &#125;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (priorInvokedFactoryMethod != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">//如果线程本地存在，就设置回老的</span><br>        currentlyInvokedFactoryMethod.set(priorInvokedFactoryMethod);<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//否则就删除，等于没设置</span><br>        currentlyInvokedFactoryMethod.remove();<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(factoryMethod,<br>        <span class="hljs-string">&quot;Illegal arguments to factory method &#x27;&quot;</span> + factoryMethod.getName() + <span class="hljs-string">&quot;&#x27;; &quot;</span> +<br>        <span class="hljs-string">&quot;args: &quot;</span> + StringUtils.arrayToCommaDelimitedString(args), ex);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(factoryMethod,<br>        <span class="hljs-string">&quot;Cannot access factory method &#x27;&quot;</span> + factoryMethod.getName() + <span class="hljs-string">&quot;&#x27;; is it public?&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>    String msg = <span class="hljs-string">&quot;Factory method &#x27;&quot;</span> + factoryMethod.getName() + <span class="hljs-string">&quot;&#x27; threw exception&quot;</span>;<br>    <span class="hljs-keyword">if</span> (bd.getFactoryBeanName() != <span class="hljs-keyword">null</span> &amp;&amp; owner <span class="hljs-keyword">instanceof</span> ConfigurableBeanFactory &amp;&amp;<br>        ((ConfigurableBeanFactory) owner).isCurrentlyInCreation(bd.getFactoryBeanName())) &#123;<br>      msg = <span class="hljs-string">&quot;Circular reference involving containing bean &#x27;&quot;</span> + bd.getFactoryBeanName() + <span class="hljs-string">&quot;&#x27; - consider &quot;</span> +<br>          <span class="hljs-string">&quot;declaring the factory method as static for independence from its containing instance. &quot;</span> + msg;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(factoryMethod, msg, ex.getTargetException());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>多个有参工厂方法</p>
<p>怎么处理有多个参数的工厂方法呢，到底哪一个才是应该调用呢。</p>
<p>方法排序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (candidates.size() &gt; <span class="hljs-number">1</span>) &#123;  <span class="hljs-comment">// explicitly skip immutable singletonList</span><br>  <span class="hljs-comment">//排序，根据public优先，参数多的优先</span><br>  candidates.sort(AutowireUtils.EXECUTABLE_COMPARATOR);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AutowireUtils.EXECUTABLE_COMPARATOR</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//先比较修饰符，再比较参数个数 从Public到非Public，参数从多到少</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Comparator&lt;Executable&gt; EXECUTABLE_COMPARATOR = (e1, e2) -&gt; &#123;<br>  <span class="hljs-keyword">int</span> result = Boolean.compare(Modifier.isPublic(e2.getModifiers()), Modifier.isPublic(e1.getModifiers()));<br>  <span class="hljs-keyword">return</span> result != <span class="hljs-number">0</span> ? result : Integer.compare(e2.getParameterCount(), e1.getParameterCount());<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>准备工作</p>
<p>因为接下去解析的工厂方法是有参数的，所以要进行一些处理，比如获取构造器参数值(如果有传的话)，然后获取自动装配模式，工厂方法一般默认是AUTOWIRE_CONSTRUCTOR，还会定义一个minTypeDiffWeight 差异值，这个就是用在如果有多个工厂方法的时候，看工厂方法的参数和具体装配的bean的类型的差异，取最小的。还定义了有个ambiguousFactoryMethods ，用来存放差异值一样的方法，说明是一样的类型，无法判断要用哪个工厂方法实例化。比如protected UserDao userDao(TestBean2 t2)和public UserDao userDao(TestBean t1)两个构造方法类型差异是一样的，所以不知道要用哪个，就会报异常啦。还有minNrOfArgs也很关键，用来做优化的，如果有最小参数个数，那么一些参数个数少于最小个数的就不需要去判断了，直接跳过，否则就算获取到了也不匹配，反而浪费资源了。如果minNrOfArgs为0，那就说明没有参数个数限制，那后面就需要一个个去判断哪个差异最小，最符合了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//构造器参数值</span><br>ConstructorArgumentValues resolvedValues = <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">boolean</span> autowiring = (mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR);<br><span class="hljs-comment">//最小的类型差距</span><br><span class="hljs-keyword">int</span> minTypeDiffWeight = Integer.MAX_VALUE;<br><span class="hljs-comment">//模棱两可的工厂方法集合</span><br>Set&lt;Method&gt; ambiguousFactoryMethods = <span class="hljs-keyword">null</span>;<br><br><span class="hljs-comment">//最小参数个数</span><br><span class="hljs-keyword">int</span> minNrOfArgs;<br><span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-comment">//如果存在显示参数，就是显示参数的个数</span><br>  minNrOfArgs = explicitArgs.length;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// We don&#x27;t have arguments passed in programmatically, so we need to resolve the</span><br>  <span class="hljs-comment">// arguments specified in the constructor arguments held in the bean definition.</span><br>  <span class="hljs-comment">//如果存在构造器参数值，就解析出最小参数个数</span><br>  <span class="hljs-keyword">if</span> (mbd.hasConstructorArgumentValues()) &#123;<br>    ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();<br>    resolvedValues = <span class="hljs-keyword">new</span> ConstructorArgumentValues();<br>    minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//没有就为 0</span><br>    minNrOfArgs = <span class="hljs-number">0</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>自动装配</p>
<p>这段最核心的，自动装配就在里面，首先前面已经过滤出candidates工厂方法了，但是我们这不知道要选哪个去实例化，所以得有个选取规则，首先参数个数不能小于最少的，如果有显示的参数存在，那个数不一致的也不要，然后就获取参数名字探测器去进行每一个工厂方法的参数名字探测，然后创建一个参数持有器，这里面就会涉及自定装配，依赖的参数会实例化。最后根据参数持有器的参数和工厂方法的参数类型作比较，保存最小的差异值的那个，把模棱两可的集合设置空。如果有相同差异值的就放入一个集合里，如果集合有数据，说明不知道用哪个工厂方法来实例化，会报异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//遍历每个后选的方法，查看可以获取实例的匹配度</span><br><span class="hljs-keyword">for</span> (Method candidate : candidates) &#123;<br>  <span class="hljs-keyword">int</span> parameterCount = candidate.getParameterCount();<br><br>  <span class="hljs-keyword">if</span> (parameterCount &gt;= minNrOfArgs) &#123;<br>    ArgumentsHolder argsHolder;<br><br>    Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();<br>    <span class="hljs-comment">//显示参数存在，如果长度不对就继续下一个，否则就创建参数持有其持有</span><br>    <span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-comment">// Explicit arguments given -&gt; arguments length must match exactly.</span><br>      <span class="hljs-keyword">if</span> (paramTypes.length != explicitArgs.length) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      argsHolder = <span class="hljs-keyword">new</span> ArgumentsHolder(explicitArgs);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// Resolved constructor arguments: type conversion and/or autowiring necessary.</span><br>      <span class="hljs-keyword">try</span> &#123;<br>        String[] paramNames = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-comment">//获取参数名字探测器</span><br>        ParameterNameDiscoverer pnd = <span class="hljs-keyword">this</span>.beanFactory.getParameterNameDiscoverer();<br>        <span class="hljs-keyword">if</span> (pnd != <span class="hljs-keyword">null</span>) &#123;<br>          <span class="hljs-comment">//存在的话进行探测</span><br>          paramNames = pnd.getParameterNames(candidate);<br>        &#125;<br>        argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw,<br>            paramTypes, paramNames, candidate, autowiring, candidates.size() == <span class="hljs-number">1</span>);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (UnsatisfiedDependencyException ex) &#123;<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>          logger.trace(<span class="hljs-string">&quot;Ignoring factory method [&quot;</span> + candidate + <span class="hljs-string">&quot;] of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + ex);<br>        &#125;<br>        <span class="hljs-comment">// Swallow and try next overloaded factory method.</span><br>        <span class="hljs-keyword">if</span> (causes == <span class="hljs-keyword">null</span>) &#123;<br>          causes = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>        &#125;<br>        causes.add(ex);<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//根据参数类型匹配，获取类型的差异值</span><br>    <span class="hljs-keyword">int</span> typeDiffWeight = (mbd.isLenientConstructorResolution() ?<br>        argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes));<br>    <span class="hljs-comment">// Choose this factory method if it represents the closest match.</span><br>    <span class="hljs-comment">//保存最小的，说明参数类型相近</span><br>    <span class="hljs-keyword">if</span> (typeDiffWeight &lt; minTypeDiffWeight) &#123;<br>      factoryMethodToUse = candidate;<br>      argsHolderToUse = argsHolder;<br>      argsToUse = argsHolder.arguments;<br>      minTypeDiffWeight = typeDiffWeight;<br>      ambiguousFactoryMethods = <span class="hljs-keyword">null</span>;<span class="hljs-comment">//没有模棱两可的方法</span><br>    &#125;<br><br>    <span class="hljs-comment">//如果出现类型差异相同，参数个数也相同的，而且需要严格判断，参数长度也一样，常数类型也一样，就可能会无法判定要实例化哪个，就会报异常</span><br><br>    <span class="hljs-comment">// Find out about ambiguity: In case of the same type difference weight</span><br>    <span class="hljs-comment">// for methods with the same number of parameters, collect such candidates</span><br>    <span class="hljs-comment">// and eventually raise an ambiguity exception.</span><br>    <span class="hljs-comment">// However, only perform that check in non-lenient constructor resolution mode,</span><br>    <span class="hljs-comment">// and explicitly ignore overridden methods (with the same parameter signature).</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (factoryMethodToUse != <span class="hljs-keyword">null</span> &amp;&amp; typeDiffWeight == minTypeDiffWeight &amp;&amp;<br>        !mbd.isLenientConstructorResolution() &amp;&amp;<br>        paramTypes.length == factoryMethodToUse.getParameterCount() &amp;&amp;<br>        !Arrays.equals(paramTypes, factoryMethodToUse.getParameterTypes())) &#123;<br>      <span class="hljs-keyword">if</span> (ambiguousFactoryMethods == <span class="hljs-keyword">null</span>) &#123;<br>        ambiguousFactoryMethods = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<br>        ambiguousFactoryMethods.add(factoryMethodToUse);<br>      &#125;<br>      ambiguousFactoryMethods.add(candidate);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="determineConstructorsFromBeanPostProcessors"><a href="#determineConstructorsFromBeanPostProcessors" class="headerlink" title="determineConstructorsFromBeanPostProcessors"></a>determineConstructorsFromBeanPostProcessors</h4><ul>
<li>前面是工厂方法的实例化</li>
<li>现在可以讲一般的构造方法实例化了，首先会进行处理器处理，找出合适的构造方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">protected</span> Constructor&lt;?&gt;[] determineConstructorsFromBeanPostProcessors(<span class="hljs-meta">@Nullable</span> Class&lt;?&gt; beanClass, String beanName)<br>    <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>  <span class="hljs-keyword">if</span> (beanClass != <span class="hljs-keyword">null</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br>    <span class="hljs-keyword">for</span> (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123;<br>      Constructor&lt;?&gt;[] ctors = bp.determineCandidateConstructors(beanClass, beanName);<br>      <span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> ctors;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>SmartInstantiationAwareBeanPostProcessor 接口</p>
<p>AutowiredAnnotationBeanPostProcessor#determineCandidateConstructors</p>
<p>方法很复杂，拷一份过来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, <span class="hljs-keyword">final</span> String beanName)<br>    <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><br>  <span class="hljs-comment">// 查找lookup</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.lookupMethodsChecked.contains(beanName)) &#123;<br>    <span class="hljs-keyword">if</span> (AnnotationUtils.isCandidateClass(beanClass, Lookup.class)) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        Class&lt;?&gt; targetClass = beanClass;<br>        <span class="hljs-keyword">do</span> &#123;<span class="hljs-comment">//遍历当前类以及所有父类，找出Lookup注解的方法进行处理</span><br>          ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;<br>            Lookup lookup = method.getAnnotation(Lookup.class);<br>            <span class="hljs-keyword">if</span> (lookup != <span class="hljs-keyword">null</span>) &#123;<br>              Assert.state(<span class="hljs-keyword">this</span>.beanFactory != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;No BeanFactory available&quot;</span>);<br>              LookupOverride override = <span class="hljs-keyword">new</span> LookupOverride(method, lookup.value());<br>              <span class="hljs-keyword">try</span> &#123;<br>                RootBeanDefinition mbd = (RootBeanDefinition)<br>                    <span class="hljs-keyword">this</span>.beanFactory.getMergedBeanDefinition(beanName);<br>                mbd.getMethodOverrides().addOverride(override);<br>              &#125;<br>              <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,<br>                    <span class="hljs-string">&quot;Cannot apply @Lookup to beans without corresponding bean definition&quot;</span>);<br>              &#125;<br>            &#125;<br>          &#125;);<br>          targetClass = targetClass.getSuperclass();<br>        &#125;<br>        <span class="hljs-keyword">while</span> (targetClass != <span class="hljs-keyword">null</span> &amp;&amp; targetClass != Object.class);<span class="hljs-comment">//遍历父类，直到Object</span><br><br>      &#125;<br>      <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">&quot;Lookup method resolution failed&quot;</span>, ex);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">this</span>.lookupMethodsChecked.add(beanName);<span class="hljs-comment">//已经检查过</span><br>  &#125;<br><br>  <span class="hljs-comment">//先检查一遍缓存</span><br>  Constructor&lt;?&gt;[] candidateConstructors = <span class="hljs-keyword">this</span>.candidateConstructorsCache.get(beanClass);<br>  <span class="hljs-keyword">if</span> (candidateConstructors == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//没找到再同步</span><br>    <span class="hljs-comment">// Fully synchronized resolution now...</span><br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.candidateConstructorsCache) &#123;<br>      candidateConstructors = <span class="hljs-keyword">this</span>.candidateConstructorsCache.get(beanClass);<span class="hljs-comment">//再检测一遍，双重检测</span><br>      <span class="hljs-keyword">if</span> (candidateConstructors == <span class="hljs-keyword">null</span>) &#123;<br>        Constructor&lt;?&gt;[] rawCandidates;<br>        <span class="hljs-keyword">try</span> &#123;<br>          rawCandidates = beanClass.getDeclaredConstructors();<span class="hljs-comment">//获取所有构造方法</span><br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,<br>              <span class="hljs-string">&quot;Resolution of declared constructors on bean Class [&quot;</span> + beanClass.getName() +<br>              <span class="hljs-string">&quot;] from ClassLoader [&quot;</span> + beanClass.getClassLoader() + <span class="hljs-string">&quot;] failed&quot;</span>, ex);<br>        &#125;<br>        List&lt;Constructor&lt;?&gt;&gt; candidates = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(rawCandidates.length);<br>        Constructor&lt;?&gt; requiredConstructor = <span class="hljs-keyword">null</span>;<span class="hljs-comment">//需要的构造方法</span><br>        Constructor&lt;?&gt; defaultConstructor = <span class="hljs-keyword">null</span>;<span class="hljs-comment">//默认构造方法</span><br>        Constructor&lt;?&gt; primaryConstructor = BeanUtils.findPrimaryConstructor(beanClass);<span class="hljs-comment">//优先的构造方法，Kotlin的类才有，一般都是空</span><br>        <span class="hljs-keyword">int</span> nonSyntheticConstructors = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Constructor&lt;?&gt; candidate : rawCandidates) &#123;<br>          <span class="hljs-keyword">if</span> (!candidate.isSynthetic()) &#123;<span class="hljs-comment">//非合成的方法</span><br>            nonSyntheticConstructors++;<br>          &#125;<br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (primaryConstructor != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>          &#125;<br>          MergedAnnotation&lt;?&gt; ann = findAutowiredAnnotation(candidate);<span class="hljs-comment">//寻找Autowired和value的注解</span><br>          <span class="hljs-keyword">if</span> (ann == <span class="hljs-keyword">null</span>) &#123;<br>            Class&lt;?&gt; userClass = ClassUtils.getUserClass(beanClass);<br>            <span class="hljs-keyword">if</span> (userClass != beanClass) &#123;<span class="hljs-comment">//如果是有代理的，找到被代理类</span><br>              <span class="hljs-keyword">try</span> &#123;<br>                Constructor&lt;?&gt; superCtor =<span class="hljs-comment">//获取构造方法</span><br>                    userClass.getDeclaredConstructor(candidate.getParameterTypes());<br>                ann = findAutowiredAnnotation(superCtor);<span class="hljs-comment">//继续寻找Autowired和value的注解</span><br>              &#125;<br>              <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br>                <span class="hljs-comment">// Simply proceed, no equivalent superclass constructor found...</span><br>              &#125;<br>            &#125;<br>          &#125;<br>          <span class="hljs-keyword">if</span> (ann != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (requiredConstructor != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//有两个Autowired注解，冲突了</span><br>              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,<br>                  <span class="hljs-string">&quot;Invalid autowire-marked constructor: &quot;</span> + candidate +<br>                  <span class="hljs-string">&quot;. Found constructor with &#x27;required&#x27; Autowired annotation already: &quot;</span> +<br>                  requiredConstructor);<br>            &#125;<br>            <span class="hljs-keyword">boolean</span> required = determineRequiredStatus(ann);<span class="hljs-comment">//是否需要，默认是true</span><br>            <span class="hljs-keyword">if</span> (required) &#123;<br>              <span class="hljs-keyword">if</span> (!candidates.isEmpty()) &#123;<span class="hljs-comment">//如果已经有required=false了，又来了一个required=true的方法就报异常了，这样两个可能就不知道用哪个了</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,<br>                    <span class="hljs-string">&quot;Invalid autowire-marked constructors: &quot;</span> + candidates +<br>                    <span class="hljs-string">&quot;. Found constructor with &#x27;required&#x27; Autowired annotation: &quot;</span> +<br>                    candidate);<br>              &#125;<br>              requiredConstructor = candidate;<br>            &#125;<br>            candidates.add(candidate);<span class="hljs-comment">//加入集合</span><br>          &#125;<br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidate.getParameterCount() == <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//是无参构造方法</span><br>            defaultConstructor = candidate;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!candidates.isEmpty()) &#123;<span class="hljs-comment">//如果候选不为空，基本就是有Autowired注解的，转换成数组直接返回</span><br>          <span class="hljs-comment">// Add default constructor to list of optional constructors, as fallback.</span><br>          <span class="hljs-keyword">if</span> (requiredConstructor == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (defaultConstructor != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//添加默认构造函数</span><br>              candidates.add(defaultConstructor);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidates.size() == <span class="hljs-number">1</span> &amp;&amp; logger.isInfoEnabled()) &#123;<br>              logger.info(<span class="hljs-string">&quot;Inconsistent constructor declaration on bean with name &#x27;&quot;</span> + beanName +<br>                  <span class="hljs-string">&quot;&#x27;: single autowire-marked constructor flagged as optional - &quot;</span> +<br>                  <span class="hljs-string">&quot;this constructor is effectively required since there is no &quot;</span> +<br>                  <span class="hljs-string">&quot;default constructor to fall back to: &quot;</span> + candidates.get(<span class="hljs-number">0</span>));<br>            &#125;<br>          &#125;<br>          candidateConstructors = candidates.toArray(<span class="hljs-keyword">new</span> Constructor&lt;?&gt;[<span class="hljs-number">0</span>]);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rawCandidates.length == <span class="hljs-number">1</span> &amp;&amp; rawCandidates[<span class="hljs-number">0</span>].getParameterCount() &gt; <span class="hljs-number">0</span>) &#123;<br>          candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[] &#123;rawCandidates[<span class="hljs-number">0</span>]&#125;;<span class="hljs-comment">//只有一个函数且有参数</span><br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nonSyntheticConstructors == <span class="hljs-number">2</span> &amp;&amp; primaryConstructor != <span class="hljs-keyword">null</span> &amp;&amp;<br>            defaultConstructor != <span class="hljs-keyword">null</span> &amp;&amp; !primaryConstructor.equals(defaultConstructor)) &#123;<br>          candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[] &#123;primaryConstructor, defaultConstructor&#125;;<span class="hljs-comment">//有两个非合成方法，有优先方法和默认方法，且不相同</span><br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nonSyntheticConstructors == <span class="hljs-number">1</span> &amp;&amp; primaryConstructor != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//只有一个优先的</span><br>          candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[] &#123;primaryConstructor&#125;;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//大于2个没注解的构造方法就不知道要用什么了，所以就返回null</span><br>          candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[<span class="hljs-number">0</span>];<br>        &#125;<br>        <span class="hljs-keyword">this</span>.candidateConstructorsCache.put(beanClass, candidateConstructors);<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> (candidateConstructors.length &gt; <span class="hljs-number">0</span> ? candidateConstructors : <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>总结如下：</p>
<ul>
<li>如果有多个Autowired，required有true，不管有没有默认构造方法，会报异常。</li>
<li>如果只有一个Autowired，required是false，没有默认构造方法，会报警告。</li>
<li>如果没有Autowired注解，定义了2个及以上有参数的构造方法，没有无参构造方法，就会报错。</li>
<li>其他情况都可以，但是以有Autowired的构造方法优先，然后才是默认构造方法。</li>
</ul>
<p>如果构造方法存在且是有参数的，那就会调用autowireConstructor进行自动装配，如果不存在基本上无参构造方法了</p>
<h4 id="autowireConstructor-有参构造方法自动装配"><a href="#autowireConstructor-有参构造方法自动装配" class="headerlink" title="autowireConstructor 有参构造方法自动装配"></a>autowireConstructor 有参构造方法自动装配</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title">autowireConstructor</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Constructor&lt;?&gt;[] ctors, <span class="hljs-meta">@Nullable</span> Object[] explicitArgs)</span> </span>&#123;<br>    <br>  <span class="hljs-comment">//ConstructorResolver</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConstructorResolver(<span class="hljs-keyword">this</span>).autowireConstructor(beanName, mbd, ctors, explicitArgs);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ConstructorResolver#autowireConstructor</p>
<p>这个和前面讲过的工厂方法实例化instantiateUsingFactoryMethod很像，但是有几个地方不一样</p>
<ul>
<li>工厂方法会遍历完所有的方法，然后找出参数类型差异最小的方法，而自动装配构造方法找到一个满足条件的就停止了。</li>
<li>参数类型差异算法不一样，工厂方法是用严格的方法getAssignabilityWeight，而自动装配是宽松的方法getTypeDifferenceWeight。</li>
</ul>
<h4 id="instantiateBean-无参构造方法实例化"><a href="#instantiateBean-无参构造方法实例化" class="headerlink" title="instantiateBean 无参构造方法实例化"></a>instantiateBean 无参构造方法实例化</h4><p>其实里面就是获取实例化的策略，然后进行instantiate实例化</p>
<p>前面有说过策略是CglibSubclassingInstantiationStrategy的,但是只会在注入的时候起作用</p>
<p>一般的还是用父类SimpleInstantiationStrategy的instantiate。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title">instantiateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd)</span> </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    Object beanInstance;<br>    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>      beanInstance = AccessController.doPrivileged(<br>          (PrivilegedAction&lt;Object&gt;) () -&gt; getInstantiationStrategy().instantiate(mbd, beanName, <span class="hljs-keyword">this</span>),<br>          getAccessControlContext());<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, <span class="hljs-keyword">this</span>);<br>    &#125;<br>    BeanWrapper bw = <span class="hljs-keyword">new</span> BeanWrapperImpl(beanInstance);<br>    initBeanWrapper(bw);<br>    <span class="hljs-keyword">return</span> bw;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(<br>        mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Instantiation of bean failed&quot;</span>, ex);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>BeanUtils#instantiateClass</p>
<p>调用构造方法反射创建对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">instantiateClass</span><span class="hljs-params">(Constructor&lt;T&gt; ctor, Object... args)</span> <span class="hljs-keyword">throws</span> BeanInstantiationException </span>&#123;<br>  Assert.notNull(ctor, <span class="hljs-string">&quot;Constructor must not be null&quot;</span>);<br>  <span class="hljs-keyword">try</span> &#123;<br>    ReflectionUtils.makeAccessible(ctor);<br>    <span class="hljs-keyword">if</span> (KotlinDetector.isKotlinReflectPresent() &amp;&amp; KotlinDetector.isKotlinType(ctor.getDeclaringClass())) &#123;<br>      <span class="hljs-keyword">return</span> KotlinDelegate.instantiateClass(ctor, args);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      Class&lt;?&gt;[] parameterTypes = ctor.getParameterTypes();<br>      Assert.isTrue(args.length &lt;= parameterTypes.length, <span class="hljs-string">&quot;Can&#x27;t specify more arguments than constructor parameters&quot;</span>);<br>      Object[] argsWithDefaultValues = <span class="hljs-keyword">new</span> Object[args.length];<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span> ; i &lt; args.length; i++) &#123;<br>        <span class="hljs-keyword">if</span> (args[i] == <span class="hljs-keyword">null</span>) &#123;<br>          Class&lt;?&gt; parameterType = parameterTypes[i];<br>          argsWithDefaultValues[i] = (parameterType.isPrimitive() ? DEFAULT_TYPE_VALUES.get(parameterType) : <span class="hljs-keyword">null</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          argsWithDefaultValues[i] = args[i];<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> ctor.newInstance(argsWithDefaultValues);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (InstantiationException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(ctor, <span class="hljs-string">&quot;Is it an abstract class?&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(ctor, <span class="hljs-string">&quot;Is the constructor accessible?&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(ctor, <span class="hljs-string">&quot;Illegal arguments for constructor&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(ctor, <span class="hljs-string">&quot;Constructor threw exception&quot;</span>, ex.getTargetException());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>CglibSubclassingInstantiationStrategy#instantiateWithMethodInjection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">instantiateWithMethodInjection</span><span class="hljs-params">(RootBeanDefinition bd, <span class="hljs-meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner, <span class="hljs-keyword">null</span>);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">instantiateWithMethodInjection</span><span class="hljs-params">(RootBeanDefinition bd, <span class="hljs-meta">@Nullable</span> String beanName, BeanFactory owner,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-meta">@Nullable</span> Constructor&lt;?&gt; ctor, Object... args)</span> </span>&#123;<br><br>  <span class="hljs-comment">// Must generate CGLIB subclass...</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CglibSubclassCreator(bd, owner).instantiate(ctor, args);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>CglibSubclassCreator#instantiate</p>
<ul>
<li>创建一个GCLIB的增强器子类</li>
<li>如果传入构造方法是空的话就用BeanUtils进行GCLIB子类的实例化,否则就用增强子类的构造方法直接实例化。</li>
<li>然后设置方法拦截器，这样调用的时候就会进入拦截器里，就可以去容器里寻找，有就直接返回，没有就创建。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">instantiate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Constructor&lt;?&gt; ctor, Object... args)</span> </span>&#123;<br>  Class&lt;?&gt; subclass = createEnhancedSubclass(<span class="hljs-keyword">this</span>.beanDefinition);<br>  Object instance;<br>  <span class="hljs-keyword">if</span> (ctor == <span class="hljs-keyword">null</span>) &#123;<br>    instance = BeanUtils.instantiateClass(subclass);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes());<br>      instance = enhancedSubclassConstructor.newInstance(args);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(<span class="hljs-keyword">this</span>.beanDefinition.getBeanClass(),<br>          <span class="hljs-string">&quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot;</span> + subclass.getName() + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// SPR-10785: set callbacks directly on the instance instead of in the</span><br>  <span class="hljs-comment">// enhanced class (via the Enhancer) in order to avoid memory leaks.</span><br>  Factory factory = (Factory) instance;<br>  factory.setCallbacks(<span class="hljs-keyword">new</span> Callback[] &#123;NoOp.INSTANCE,<br>      <span class="hljs-keyword">new</span> LookupOverrideMethodInterceptor(<span class="hljs-keyword">this</span>.beanDefinition, <span class="hljs-keyword">this</span>.owner),<br>      <span class="hljs-keyword">new</span> ReplaceOverrideMethodInterceptor(<span class="hljs-keyword">this</span>.beanDefinition, <span class="hljs-keyword">this</span>.owner)&#125;);<br>  <span class="hljs-keyword">return</span> instance;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至此，spring bean 实例化就已经完成了，但是此时的Bean只实例化出来，什么都没有做，是一个白板</p>
<h3 id="applyMergedBeanDefinitionPostProcessors"><a href="#applyMergedBeanDefinitionPostProcessors" class="headerlink" title="applyMergedBeanDefinitionPostProcessors"></a>applyMergedBeanDefinitionPostProcessors</h3><p>处理器修改合并bean定义</p>
<p>前面实例化完成了，之后要进行处理器的处理，也就是 <code>MergedBeanDefinitionPostProcessor</code> 处理器的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyMergedBeanDefinitionPostProcessors</span><span class="hljs-params">(RootBeanDefinition mbd, Class&lt;?&gt; beanType, String beanName)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (MergedBeanDefinitionPostProcessor processor : getBeanPostProcessorCache().mergedDefinition) &#123;<br>    processor.postProcessMergedBeanDefinition(mbd, beanType, beanName);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>MergedBeanDefinitionPostProcessor 的实现有很多，但是绝大多数为spring定义的</p>
<ul>
<li>CommonAnnotationBeanPostProcessor<ul>
<li>实现待补充</li>
</ul>
</li>
<li>AutowiredAnnotationBeanPostProcessor<ul>
<li>实现待补充</li>
<li>AutowiredAnnotationBeanPostProcessor#applyMergedBeanDefinitionPostProcessors主要做的事就是用处理器把属性和方法上的自动装配的信息记录下来，放到bean定义里，后面进行填充的时候可以用到，其中就包括CommonAnnotationBeanPostProcessor的生命周期方法和webService，ejb，Resource注解信息以及AutowiredAnnotationBeanPostProcessor的Autowired和Value注解信息。</li>
</ul>
</li>
</ul>
<h3 id="populateBean-属性填充"><a href="#populateBean-属性填充" class="headerlink" title="populateBean 属性填充"></a>populateBean 属性填充</h3><h4 id="InstantiationAwareBeanPostProcessor"><a href="#InstantiationAwareBeanPostProcessor" class="headerlink" title="InstantiationAwareBeanPostProcessor"></a>InstantiationAwareBeanPostProcessor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在填充属性前，还会给InstantiationAwareBeanPostProcessor的处理器处理，给他们机会让他们去修改bean实例，这里也是扩展点</span><br><br><span class="hljs-comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span><br><span class="hljs-comment">// state of the bean before properties are set. This can be used, for example,</span><br><span class="hljs-comment">// to support styles of field injection.</span><br><span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br>  <span class="hljs-keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;<br>    <span class="hljs-keyword">if</span> (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;<br>      <span class="hljs-comment">// 如果返回 false 就停止属性填充</span><br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="获取自动装配模式"><a href="#获取自动装配模式" class="headerlink" title="获取自动装配模式"></a>获取自动装配模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="hljs-keyword">null</span>);<br><br><span class="hljs-comment">//获取自动装配模式,默认是no</span><br><br><span class="hljs-keyword">int</span> resolvedAutowireMode = mbd.getResolvedAutowireMode();<br><span class="hljs-keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;<br>  MutablePropertyValues newPvs = <span class="hljs-keyword">new</span> MutablePropertyValues(pvs);<br>  <span class="hljs-comment">// Add property values based on autowire by name if applicable.</span><br>  <span class="hljs-keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123;<br>    autowireByName(beanName, mbd, bw, newPvs);<br>  &#125;<br>  <span class="hljs-comment">// Add property values based on autowire by type if applicable.</span><br>  <span class="hljs-keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;<br>    autowireByType(beanName, mbd, bw, newPvs);<br>  &#125;<br>  pvs = newPvs;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="InstantiationAwareBeanPostProcessor-postProcessProperties"><a href="#InstantiationAwareBeanPostProcessor-postProcessProperties" class="headerlink" title="InstantiationAwareBeanPostProcessor#postProcessProperties"></a>InstantiationAwareBeanPostProcessor#postProcessProperties</h4><p>这里会进行InstantiationAwareBeanPostProcessor处理器的postProcessProperties处理；拓展点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();<br><span class="hljs-keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);<br><br>PropertyDescriptor[] filteredPds = <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">if</span> (hasInstAwareBpps) &#123;<br>  <span class="hljs-keyword">if</span> (pvs == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// 创建PropertyValues</span><br>    pvs = mbd.getPropertyValues();<br>  &#125;<br>  <span class="hljs-comment">// 继续后置处理器处理</span><br>  <span class="hljs-keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;<br>    PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);<br>    <span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-keyword">null</span>) &#123;<br>        filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>      &#125;<br>      pvsToUse = bp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);<br>      <span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>    &#125;<br>    pvs = pvsToUse;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">if</span> (needsDepCheck) &#123;<br>  <span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-keyword">null</span>) &#123;<br>    filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>  &#125;<br>  checkDependencies(beanName, mbd, filteredPds, pvs);<br>&#125;<br><br><span class="hljs-keyword">if</span> (pvs != <span class="hljs-keyword">null</span>) &#123;<br>  applyPropertyValues(beanName, mbd, bw, pvs);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ImportAwareBeanPostProcessor#postProcessProperties</p>
<p>这个就是前面如果配置类有Configuration注解，会进行动态代理，会实现EnhancedConfiguration接口，里面有个setBeanFactory接口方法，会传入beanFactory。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title">postProcessProperties</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> PropertyValues pvs, Object bean, String beanName)</span> </span>&#123;<br>  <span class="hljs-comment">// Inject the BeanFactory before AutowiredAnnotationBeanPostProcessor&#x27;s</span><br>  <span class="hljs-comment">// postProcessProperties method attempts to autowire other configuration beans.</span><br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> EnhancedConfiguration) &#123;<br>    ((EnhancedConfiguration) bean).setBeanFactory(<span class="hljs-keyword">this</span>.beanFactory);<br>  &#125;<br>  <span class="hljs-keyword">return</span> pvs;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>CommonAnnotationBeanPostProcessor</code> 的 <code>postProcessProperties</code></p>
<p>处理 @Resource 注解</p>
<p>这里就处理我们前面 <code>applyMergedBeanDefinitionPostProcessors</code> 处理注入注解元数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> </span>&#123;<br>  InjectionMetadata metadata = findResourceMetadata(beanName, bean.getClass(), pvs);<br>  <span class="hljs-keyword">try</span> &#123;<br>    metadata.inject(bean, beanName, pvs);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">&quot;Injection of resource dependencies failed&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">return</span> pvs;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">inject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>  Collection&lt;InjectedElement&gt; checkedElements = <span class="hljs-keyword">this</span>.checkedElements;<br>  Collection&lt;InjectedElement&gt; elementsToIterate =<br>      (checkedElements != <span class="hljs-keyword">null</span> ? checkedElements : <span class="hljs-keyword">this</span>.injectedElements);<br>  <span class="hljs-keyword">if</span> (!elementsToIterate.isEmpty()) &#123;<br>    <span class="hljs-keyword">for</span> (InjectedElement element : elementsToIterate) &#123;<br>      <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>        logger.trace(<span class="hljs-string">&quot;Processing injected element of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + element);<br>      &#125;<br>      element.inject(target, beanName, pvs);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">inject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String requestingBeanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span></span><br><span class="hljs-function">				<span class="hljs-keyword">throws</span> Throwable </span>&#123;<br><br>  <span class="hljs-comment">//属性注入</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isField) &#123;<br>    Field field = (Field) <span class="hljs-keyword">this</span>.member;<br>    ReflectionUtils.makeAccessible(field);<br>    field.set(target, getResourceToInject(target, requestingBeanName));<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (checkPropertySkipping(pvs)) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">//方法注入</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      Method method = (Method) <span class="hljs-keyword">this</span>.member;<br>      ReflectionUtils.makeAccessible(method);<br>      method.invoke(target, getResourceToInject(target, requestingBeanName));<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>      <span class="hljs-keyword">throw</span> ex.getTargetException();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ResourceElement#getResourceToInject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getResourceToInject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.lazyLookup ? buildLazyResourceProxy(<span class="hljs-keyword">this</span>, requestingBeanName) :<br>      getResource(<span class="hljs-keyword">this</span>, requestingBeanName));<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getResource</span><span class="hljs-params">(LookupElement element, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span></span><br><span class="hljs-function">			<span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;<br><br>  <span class="hljs-keyword">if</span> (StringUtils.hasLength(element.mappedName)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.jndiFactory.getBean(element.mappedName, element.lookupType);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.alwaysUseJndiLookup) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.jndiFactory.getBean(element.name, element.lookupType);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.resourceFactory == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchBeanDefinitionException(element.lookupType,<br>        <span class="hljs-string">&quot;No resource factory configured - specify the &#x27;resourceFactory&#x27; property&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> autowireResource(<span class="hljs-keyword">this</span>.resourceFactory, element, requestingBeanName);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>会调到 CommonAnnotationBeanPostProcessor#autowireResource</p>
<p>这里主要就是根据依赖描述进行工厂的解析，最后都是调用getBean(String name, Class<T> requiredType)方法，最后获取之后再注册到依赖映射里。其实这个有个resolveBeanByName，看起来好像是名字优先，其实也会获取类型的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">autowireResource</span><span class="hljs-params">(BeanFactory factory, LookupElement element, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;<br><br>  <span class="hljs-comment">//自动装配的对象</span><br>  Object resource;<br><br>  <span class="hljs-comment">//自动装配的名字</span><br>  Set&lt;String&gt; autowiredBeanNames;<br><br>  <span class="hljs-comment">//依赖的属性名</span><br>  String name = element.name;<br><br>  <span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> AutowireCapableBeanFactory) &#123;<br>    AutowireCapableBeanFactory beanFactory = (AutowireCapableBeanFactory) factory;<br>    <span class="hljs-comment">//创建依赖描述</span><br>    DependencyDescriptor descriptor = element.getDependencyDescriptor();<br>    <span class="hljs-comment">//不包含依赖对象，或者依赖对象的bean定义，只能通过解析类型去处理</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.fallbackToDefaultTypeMatch &amp;&amp; element.isDefaultName &amp;&amp; !factory.containsBean(name)) &#123;<br>      autowiredBeanNames = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<br>      resource = beanFactory.resolveDependency(descriptor, requestingBeanName, autowiredBeanNames, <span class="hljs-keyword">null</span>);<br>      <span class="hljs-keyword">if</span> (resource == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchBeanDefinitionException(element.getLookupType(), <span class="hljs-string">&quot;No resolvable resource object&quot;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//获取依赖对象，里面就是getBean</span><br>      resource = beanFactory.resolveBeanByName(name, descriptor);<br>      <span class="hljs-comment">//装配好的bean名字</span><br>      autowiredBeanNames = Collections.singleton(name);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    resource = factory.getBean(name, element.lookupType);<br>    autowiredBeanNames = Collections.singleton(name);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> ConfigurableBeanFactory) &#123;<br>    ConfigurableBeanFactory beanFactory = (ConfigurableBeanFactory) factory;<br>    <span class="hljs-keyword">for</span> (String autowiredBeanName : autowiredBeanNames) &#123;<br>      <span class="hljs-keyword">if</span> (requestingBeanName != <span class="hljs-keyword">null</span> &amp;&amp; beanFactory.containsBean(autowiredBeanName)) &#123;<br>        <span class="hljs-comment">//注册依赖关系</span><br>        beanFactory.registerDependentBean(autowiredBeanName, requestingBeanName);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> resource;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AutowiredAnnotationBeanPostProcessor#postProcessProperties</p>
<p>处理 @Autowire 注解</p>
<p>和前面CommonAnnotationBeanPostProcessor的很像，都是这个模板。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> </span>&#123;<br>  InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);<br>  <span class="hljs-keyword">try</span> &#123;<br>    metadata.inject(bean, beanName, pvs);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br>    <span class="hljs-keyword">throw</span> ex;<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">return</span> pvs;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>但是最后是AutowiredFieldElement类型的方法，前面是ResourceElement的，他们都是InjectedElement的子类，ResourceElement把处理属性和方法放一起判断处理，自动装配的AutowiredFieldElement和AutowiredMethodElement是分开处理的。</p>
<p>AutowiredFieldElement#inject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">inject</span><span class="hljs-params">(Object bean, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>  Field field = (Field) <span class="hljs-keyword">this</span>.member;<br>  Object value;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cached) &#123;<br>    value = resolvedCachedArgument(beanName, <span class="hljs-keyword">this</span>.cachedFieldValue);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    DependencyDescriptor desc = <span class="hljs-keyword">new</span> DependencyDescriptor(field, <span class="hljs-keyword">this</span>.required);<br>    desc.setContainingClass(bean.getClass());<br>    Set&lt;String&gt; autowiredBeanNames = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(<span class="hljs-number">1</span>);<br>    Assert.state(beanFactory != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;No BeanFactory available&quot;</span>);<br>    TypeConverter typeConverter = beanFactory.getTypeConverter();<br>    <span class="hljs-keyword">try</span> &#123;<br>      value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsatisfiedDependencyException(<span class="hljs-keyword">null</span>, beanName, <span class="hljs-keyword">new</span> InjectionPoint(field), ex);<br>    &#125;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.cached) &#123;<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span> || <span class="hljs-keyword">this</span>.required) &#123;<br>          <span class="hljs-keyword">this</span>.cachedFieldValue = desc;<br>          registerDependentBeans(beanName, autowiredBeanNames);<br>          <span class="hljs-keyword">if</span> (autowiredBeanNames.size() == <span class="hljs-number">1</span>) &#123;<br>            String autowiredBeanName = autowiredBeanNames.iterator().next();<br>            <span class="hljs-keyword">if</span> (beanFactory.containsBean(autowiredBeanName) &amp;&amp;<br>                beanFactory.isTypeMatch(autowiredBeanName, field.getType())) &#123;<br>              <span class="hljs-keyword">this</span>.cachedFieldValue = <span class="hljs-keyword">new</span> ShortcutDependencyDescriptor(<br>                  desc, autowiredBeanName, field.getType());<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">this</span>.cachedFieldValue = <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">this</span>.cached = <span class="hljs-keyword">true</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) &#123;<br>    ReflectionUtils.makeAccessible(field);<br>    field.set(bean, value);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AutowiredAnnotationBeanPostProcessor#resolvedCachedArgument</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">resolvedCachedArgument</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> Object cachedArgument)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (cachedArgument <span class="hljs-keyword">instanceof</span> DependencyDescriptor) &#123;<br>    DependencyDescriptor descriptor = (DependencyDescriptor) cachedArgument;<br>    Assert.state(<span class="hljs-keyword">this</span>.beanFactory != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;No BeanFactory available&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.beanFactory.resolveDependency(descriptor, beanName, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> cachedArgument;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>关于属性主注入：</p>
<p>其实不管哪种注入的注解，原理都是一样的，都要根据名字和类型去容器里找，然后建立依赖关系</p>
<p>DefaultListableBeanFactory#resolveDependency</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">resolveDependency</span><span class="hljs-params">(DependencyDescriptor descriptor, <span class="hljs-meta">@Nullable</span> String requestingBeanName,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="hljs-meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br><br>  descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());<br>  <span class="hljs-keyword">if</span> (Optional.class == descriptor.getDependencyType()) &#123;<br>    <span class="hljs-keyword">return</span> createOptionalDependency(descriptor, requestingBeanName);<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ObjectFactory.class == descriptor.getDependencyType() ||<br>      ObjectProvider.class == descriptor.getDependencyType()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DependencyObjectProvider(descriptor, requestingBeanName);<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (javaxInjectProviderClass == descriptor.getDependencyType()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Jsr330Factory().createDependencyProvider(descriptor, requestingBeanName);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    Object result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(<br>        descriptor, requestingBeanName);<br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span>) &#123;<br>      result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DefaultListableBeanFactory#doResolveDependency</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">doResolveDependency</span><span class="hljs-params">(DependencyDescriptor descriptor, <span class="hljs-meta">@Nullable</span> String beanName,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="hljs-meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br><br>  InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor);<br>  <span class="hljs-keyword">try</span> &#123;<br>    Object shortcut = descriptor.resolveShortcut(<span class="hljs-keyword">this</span>);<br>    <span class="hljs-keyword">if</span> (shortcut != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> shortcut;<br>    &#125;<br><br>    Class&lt;?&gt; type = descriptor.getDependencyType();<br>    Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);<br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> String) &#123;<br>        String strVal = resolveEmbeddedValue((String) value);<br>        BeanDefinition bd = (beanName != <span class="hljs-keyword">null</span> &amp;&amp; containsBean(beanName) ?<br>            getMergedBeanDefinition(beanName) : <span class="hljs-keyword">null</span>);<br>        value = evaluateBeanDefinitionString(strVal, bd);<br>      &#125;<br>      TypeConverter converter = (typeConverter != <span class="hljs-keyword">null</span> ? typeConverter : getTypeConverter());<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor());<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (UnsupportedOperationException ex) &#123;<br>        <span class="hljs-comment">// A custom TypeConverter which does not support TypeDescriptor resolution...</span><br>        <span class="hljs-keyword">return</span> (descriptor.getField() != <span class="hljs-keyword">null</span> ?<br>            converter.convertIfNecessary(value, type, descriptor.getField()) :<br>            converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));<br>      &#125;<br>    &#125;<br><br>    Object multipleBeans = resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);<br>    <span class="hljs-keyword">if</span> (multipleBeans != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> multipleBeans;<br>    &#125;<br><br>    Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);<br>    <span class="hljs-keyword">if</span> (matchingBeans.isEmpty()) &#123;<br>      <span class="hljs-keyword">if</span> (isRequired(descriptor)) &#123;<br>        raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    String autowiredBeanName;<br>    Object instanceCandidate;<br><br>    <span class="hljs-keyword">if</span> (matchingBeans.size() &gt; <span class="hljs-number">1</span>) &#123;<br>      autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);<br>      <span class="hljs-keyword">if</span> (autowiredBeanName == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (isRequired(descriptor) || !indicatesMultipleBeans(type)) &#123;<br>          <span class="hljs-keyword">return</span> descriptor.resolveNotUnique(descriptor.getResolvableType(), matchingBeans);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// In case of an optional Collection/Map, silently ignore a non-unique case:</span><br>          <span class="hljs-comment">// possibly it was meant to be an empty collection of multiple regular beans</span><br>          <span class="hljs-comment">// (before 4.3 in particular when we didn&#x27;t even look for collection beans).</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>      &#125;<br>      instanceCandidate = matchingBeans.get(autowiredBeanName);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// We have exactly one match.</span><br>      Map.Entry&lt;String, Object&gt; entry = matchingBeans.entrySet().iterator().next();<br>      autowiredBeanName = entry.getKey();<br>      instanceCandidate = entry.getValue();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (autowiredBeanNames != <span class="hljs-keyword">null</span>) &#123;<br>      autowiredBeanNames.add(autowiredBeanName);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (instanceCandidate <span class="hljs-keyword">instanceof</span> Class) &#123;<br>      instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, <span class="hljs-keyword">this</span>);<br>    &#125;<br>    Object result = instanceCandidate;<br>    <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> NullBean) &#123;<br>      <span class="hljs-keyword">if</span> (isRequired(descriptor)) &#123;<br>        raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);<br>      &#125;<br>      result = <span class="hljs-keyword">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ClassUtils.isAssignableValue(type, result)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br>  <span class="hljs-keyword">finally</span> &#123;<br>    ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>@AutoWire 自动注入，现根据type，后根据 name</p>
<h3 id="initializeBean-初始化"><a href="#initializeBean-初始化" class="headerlink" title="initializeBean 初始化"></a>initializeBean 初始化</h3><p>经过前面两步，实例已经初始化，属性也已经注入进去，此时就应该执行初始化方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 初始化</span><br>exposedObject = initializeBean(beanName, exposedObject, mbd);<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">initializeBean</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>    AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>      invokeAwareMethods(beanName, bean);<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;, getAccessControlContext());<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 执行Aware接口处理器回调</span><br>    invokeAwareMethods(beanName, bean);<br>  &#125;<br><br>  Object wrappedBean = bean;<br>  <span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) &#123;<br>    <span class="hljs-comment">// 初始化前</span><br>    wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);<br>  &#125;<br><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 初始化</span><br>    invokeInitMethods(beanName, wrappedBean, mbd);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(<br>        (mbd != <span class="hljs-keyword">null</span> ? mbd.getResourceDescription() : <span class="hljs-keyword">null</span>),<br>        beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) &#123;<br>    <span class="hljs-comment">// 初始化后</span><br>    wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> wrappedBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="invokeAwareMethods"><a href="#invokeAwareMethods" class="headerlink" title="invokeAwareMethods"></a>invokeAwareMethods</h4><p>处理BeanNameAware，BeanClassLoaderAware，BeanFactoryAware接口方法，这里BeanFactoryAware的接口要注意，如果前面配置类有CGLIB动态代理的话，这里这个方法就重复了，也就是setBeanFactory被重复调用了两次，前面一次是在EnhancedConfiguration接口的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeAwareMethods</span><span class="hljs-params">(String beanName, Object bean)</span> </span>&#123;<br>  <span class="hljs-comment">// 此处只回调部分 aware 接口</span><br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> Aware) &#123;<br>    <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanNameAware) &#123;<br>      ((BeanNameAware) bean).setBeanName(beanName);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanClassLoaderAware) &#123;<br>      ClassLoader bcl = getBeanClassLoader();<br>      <span class="hljs-keyword">if</span> (bcl != <span class="hljs-keyword">null</span>) &#123;<br>        ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanFactoryAware) &#123;<br>      ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="hljs-keyword">this</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="applyBeanPostProcessorsBeforeInitialization"><a href="#applyBeanPostProcessorsBeforeInitialization" class="headerlink" title="applyBeanPostProcessorsBeforeInitialization"></a>applyBeanPostProcessorsBeforeInitialization</h4><p>所有BeanPostProcessor 处理，如果有返回null了就直接返回，否则就把处理后的对象替换原来的，返回最新对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">applyBeanPostProcessorsBeforeInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br><br>  Object result = existingBean;<br>  <span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;<br>    Object current = processor.postProcessBeforeInitialization(result, beanName);<br>    <span class="hljs-keyword">if</span> (current == <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    result = current;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里是一个拓展点，这里说几个常用的 spring 的实现</p>
<p>ApplicationContextAwareProcessor#postProcessBeforeInitialization</p>
<p>如果发现bean有实现那一堆接口任意一个的话，就会执行invokeAwareInterfaces方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>  <span class="hljs-keyword">if</span> (!(bean <span class="hljs-keyword">instanceof</span> EnvironmentAware || bean <span class="hljs-keyword">instanceof</span> EmbeddedValueResolverAware ||<br>      bean <span class="hljs-keyword">instanceof</span> ResourceLoaderAware || bean <span class="hljs-keyword">instanceof</span> ApplicationEventPublisherAware ||<br>      bean <span class="hljs-keyword">instanceof</span> MessageSourceAware || bean <span class="hljs-keyword">instanceof</span> ApplicationContextAware))&#123;<br>    <span class="hljs-keyword">return</span> bean;<br>  &#125;<br><br>  AccessControlContext acc = <span class="hljs-keyword">null</span>;<br><br>  <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>    acc = <span class="hljs-keyword">this</span>.applicationContext.getBeanFactory().getAccessControlContext();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (acc != <span class="hljs-keyword">null</span>) &#123;<br>    AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>      invokeAwareInterfaces(bean);<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;, acc);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    invokeAwareInterfaces(bean);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ApplicationContextAwareProcessor#invokeAwareInterfaces</p>
<p>其实就是设置一些值，方便外部获取，做一些扩展。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeAwareInterfaces</span><span class="hljs-params">(Object bean)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> EnvironmentAware) &#123;<br>    ((EnvironmentAware) bean).setEnvironment(<span class="hljs-keyword">this</span>.applicationContext.getEnvironment());<br>  &#125;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> EmbeddedValueResolverAware) &#123;<br>    ((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(<span class="hljs-keyword">this</span>.embeddedValueResolver);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> ResourceLoaderAware) &#123;<br>    ((ResourceLoaderAware) bean).setResourceLoader(<span class="hljs-keyword">this</span>.applicationContext);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> ApplicationEventPublisherAware) &#123;<br>    ((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(<span class="hljs-keyword">this</span>.applicationContext);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> MessageSourceAware) &#123;<br>    ((MessageSourceAware) bean).setMessageSource(<span class="hljs-keyword">this</span>.applicationContext);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> ApplicationContextAware) &#123;<br>    ((ApplicationContextAware) bean).setApplicationContext(<span class="hljs-keyword">this</span>.applicationContext);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ConfigurationClassPostProcessor内部类ImportAwareBeanPostProcessor#postProcessBeforeInitialization</p>
<p>如果是ImportAware类型的，就会设置bean的注解信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> ImportAware) &#123;<br>    ImportRegistry ir = <span class="hljs-keyword">this</span>.beanFactory.getBean(IMPORT_REGISTRY_BEAN_NAME, ImportRegistry.class);<br>    AnnotationMetadata importingClass = ir.getImportingClassFor(ClassUtils.getUserClass(bean).getName());<br>    <span class="hljs-keyword">if</span> (importingClass != <span class="hljs-keyword">null</span>) &#123;<br>      ((ImportAware) bean).setImportMetadata(importingClass);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>InitDestroyAnnotationBeanPostProcessor#postProcessBeforeInitialization</p>
<p>生命周期元数据，这个时候要进行调用了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>  LifecycleMetadata metadata = findLifecycleMetadata(bean.getClass());<br>  <span class="hljs-keyword">try</span> &#123;<br>    metadata.invokeInitMethods(bean, beanName);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex.getTargetException());<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">&quot;Failed to invoke init method&quot;</span>, ex);<br>  &#125;<br>  <span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeInitMethods</span><span class="hljs-params">(Object target, String beanName)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>  Collection&lt;LifecycleElement&gt; checkedInitMethods = <span class="hljs-keyword">this</span>.checkedInitMethods;<br>  Collection&lt;LifecycleElement&gt; initMethodsToIterate =<br>      (checkedInitMethods != <span class="hljs-keyword">null</span> ? checkedInitMethods : <span class="hljs-keyword">this</span>.initMethods);<br>  <span class="hljs-keyword">if</span> (!initMethodsToIterate.isEmpty()) &#123;<br>    <span class="hljs-keyword">for</span> (LifecycleElement element : initMethodsToIterate) &#123;<br>      <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>        logger.trace(<span class="hljs-string">&quot;Invoking init method on bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + element.getMethod());<br>      &#125;<br>      element.invoke(target);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(Object target)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>  ReflectionUtils.makeAccessible(<span class="hljs-keyword">this</span>.method);<br>  <span class="hljs-keyword">this</span>.method.invoke(target, (Object[]) <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="invokeInitMethods-执行初始化方法"><a href="#invokeInitMethods-执行初始化方法" class="headerlink" title="invokeInitMethods 执行初始化方法"></a>invokeInitMethods 执行初始化方法</h4><ul>
<li>如果实现了 InitializingBean 接口的话，就可能要调用 afterPropertiesSet 方法，这是一个回调方法</li>
<li>调用自定义的初始化方法 invokeCustomInitMethod</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeInitMethods</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br><br>  <span class="hljs-comment">// 实现 InitializingBean ，并调用 afterPropertiesSet 方法</span><br>  <span class="hljs-keyword">boolean</span> isInitializingBean = (bean <span class="hljs-keyword">instanceof</span> InitializingBean);<br>  <span class="hljs-keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="hljs-keyword">null</span> || !mbd.isExternallyManagedInitMethod(<span class="hljs-string">&quot;afterPropertiesSet&quot;</span>))) &#123;<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;<br>          ((InitializingBean) bean).afterPropertiesSet();<br>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;, getAccessControlContext());<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (PrivilegedActionException pae) &#123;<br>        <span class="hljs-keyword">throw</span> pae.getException();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      ((InitializingBean) bean).afterPropertiesSet();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 执行自定义的初始化方法</span><br>  <span class="hljs-keyword">if</span> (mbd != <span class="hljs-keyword">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;<br>    String initMethodName = mbd.getInitMethodName();<br>    <span class="hljs-keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;<br>        !(isInitializingBean &amp;&amp; <span class="hljs-string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;<br>        !mbd.isExternallyManagedInitMethod(initMethodName)) &#123;<br>      invokeCustomInitMethod(beanName, bean, mbd);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>invokeCustomInitMethod</p>
<p>获取bean的自定义初始化方法，如果自身或者父类是接口类型的话，就反射出接口方法来，最后调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeCustomInitMethod</span><span class="hljs-params">(String beanName, Object bean, RootBeanDefinition mbd)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br><br>  String initMethodName = mbd.getInitMethodName();<br>  Assert.state(initMethodName != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;No init method set&quot;</span>);<br>  Method initMethod = (mbd.isNonPublicAccessAllowed() ?<br>      BeanUtils.findMethod(bean.getClass(), initMethodName) :<br>      ClassUtils.getMethodIfAvailable(bean.getClass(), initMethodName));<br><br>  <span class="hljs-keyword">if</span> (initMethod == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (mbd.isEnforceInitMethod()) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionValidationException(<span class="hljs-string">&quot;Could not find an init method named &#x27;&quot;</span> +<br>          initMethodName + <span class="hljs-string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>        logger.trace(<span class="hljs-string">&quot;No default init method named &#x27;&quot;</span> + initMethodName +<br>            <span class="hljs-string">&quot;&#x27; found on bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      <span class="hljs-comment">// Ignore non-existent default lifecycle methods.</span><br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>    logger.trace(<span class="hljs-string">&quot;Invoking init method  &#x27;&quot;</span> + initMethodName + <span class="hljs-string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>  &#125;<br>  Method methodToInvoke = ClassUtils.getInterfaceMethodIfPossible(initMethod);<br><br>  <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>    AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>      ReflectionUtils.makeAccessible(methodToInvoke);<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;);<br>    <span class="hljs-keyword">try</span> &#123;<br>      AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;)<br>          () -&gt; methodToInvoke.invoke(bean), getAccessControlContext());<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (PrivilegedActionException pae) &#123;<br>      InvocationTargetException ex = (InvocationTargetException) pae.getException();<br>      <span class="hljs-keyword">throw</span> ex.getTargetException();<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      ReflectionUtils.makeAccessible(methodToInvoke);<br>      methodToInvoke.invoke(bean);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>      <span class="hljs-keyword">throw</span> ex.getTargetException();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ClassUtils#getInterfaceMethodIfPossible</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title">getInterfaceMethodIfPossible</span><span class="hljs-params">(Method method)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!Modifier.isPublic(method.getModifiers()) || method.getDeclaringClass().isInterface()) &#123;<br>    <span class="hljs-keyword">return</span> method;<br>  &#125;<br>  <span class="hljs-keyword">return</span> interfaceMethodCache.computeIfAbsent(method, key -&gt; &#123;<br>    Class&lt;?&gt; current = key.getDeclaringClass();<br>    <span class="hljs-keyword">while</span> (current != <span class="hljs-keyword">null</span> &amp;&amp; current != Object.class) &#123;<br>      Class&lt;?&gt;[] ifcs = current.getInterfaces();<br>      <span class="hljs-keyword">for</span> (Class&lt;?&gt; ifc : ifcs) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">return</span> ifc.getMethod(key.getName(), key.getParameterTypes());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br>          <span class="hljs-comment">// ignore</span><br>        &#125;<br>      &#125;<br>      current = current.getSuperclass();<br>    &#125;<br>    <span class="hljs-keyword">return</span> key;<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="applyBeanPostProcessorsAfterInitialization"><a href="#applyBeanPostProcessorsAfterInitialization" class="headerlink" title="applyBeanPostProcessorsAfterInitialization"></a>applyBeanPostProcessorsAfterInitialization</h4><p>调用初始化后处理器，Aop就是在此处处理的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">applyBeanPostProcessorsAfterInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br><br>  Object result = existingBean;<br>  <span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;<br>    Object current = processor.postProcessAfterInitialization(result, beanName);<br>    <span class="hljs-keyword">if</span> (current == <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    result = current;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="registerDisposableBeanIfNecessary-销毁回调"><a href="#registerDisposableBeanIfNecessary-销毁回调" class="headerlink" title="registerDisposableBeanIfNecessary 销毁回调"></a>registerDisposableBeanIfNecessary 销毁回调</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerDisposableBeanIfNecessary</span><span class="hljs-params">(String beanName, Object bean, RootBeanDefinition mbd)</span> </span>&#123;<br>  AccessControlContext acc = (System.getSecurityManager() != <span class="hljs-keyword">null</span> ? getAccessControlContext() : <span class="hljs-keyword">null</span>);<br>  <span class="hljs-comment">// 不是原型并且有销毁接口的</span><br>  <span class="hljs-keyword">if</span> (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) &#123;<br>    <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>      <span class="hljs-comment">// 单例的情况，注册销毁回调</span><br>      <span class="hljs-comment">// Register a DisposableBean implementation that performs all destruction</span><br>      <span class="hljs-comment">// work for the given bean: DestructionAwareBeanPostProcessors,</span><br>      <span class="hljs-comment">// DisposableBean interface, custom destroy method.</span><br>      registerDisposableBean(beanName, <span class="hljs-keyword">new</span> DisposableBeanAdapter(<br>          bean, beanName, mbd, getBeanPostProcessorCache().destructionAware, acc));<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//自定义的，注册到 Scope</span><br>      <span class="hljs-comment">// A bean with a custom scope...</span><br>      Scope scope = <span class="hljs-keyword">this</span>.scopes.get(mbd.getScope());<br>      <span class="hljs-keyword">if</span> (scope == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + mbd.getScope() + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      scope.registerDestructionCallback(beanName, <span class="hljs-keyword">new</span> DisposableBeanAdapter(<br>          bean, beanName, mbd, getBeanPostProcessorCache().destructionAware, acc));<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AbstractBeanFactory#requiresDestruction</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">requiresDestruction</span><span class="hljs-params">(Object bean, RootBeanDefinition mbd)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> (bean.getClass() != NullBean.class &amp;&amp; (DisposableBeanAdapter.hasDestroyMethod(bean, mbd) ||<br>      (hasDestructionAwareBeanPostProcessors() &amp;&amp; DisposableBeanAdapter.hasApplicableProcessors(<br>          bean, getBeanPostProcessorCache().destructionAware))));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DisposableBeanAdapter#hasDestroyMethod</p>
<p>实现 DisposableBean 和 AutoCloseable 接口的，或者 INFER_METHOD 等于 destroyMethodName 且有 close，shutdown 方法名的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasDestroyMethod</span><span class="hljs-params">(Object bean, RootBeanDefinition beanDefinition)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> DisposableBean || bean <span class="hljs-keyword">instanceof</span> AutoCloseable) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>  &#125;<br>  String destroyMethodName = beanDefinition.getDestroyMethodName();<br>  <span class="hljs-keyword">if</span> (AbstractBeanDefinition.INFER_METHOD.equals(destroyMethodName)) &#123;<br>    <span class="hljs-keyword">return</span> (ClassUtils.hasMethod(bean.getClass(), CLOSE_METHOD_NAME) ||<br>        ClassUtils.hasMethod(bean.getClass(), SHUTDOWN_METHOD_NAME));<br>  &#125;<br>  <span class="hljs-keyword">return</span> StringUtils.hasLength(destroyMethodName);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DisposableBeanAdapter#hasApplicableProcessors</p>
<p>如果有处理器来处理的话。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasApplicableProcessors</span><span class="hljs-params">(Object bean, List&lt;DestructionAwareBeanPostProcessor&gt; postProcessors)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(postProcessors)) &#123;<br>    <span class="hljs-keyword">for</span> (DestructionAwareBeanPostProcessor processor : postProcessors) &#123;<br>      <span class="hljs-keyword">if</span> (processor.requiresDestruction(bean)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DefaultSingletonBeanRegistry#registerDisposableBean</p>
<p>其实就是把bean注册进去，到时候回调就行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerDisposableBean</span><span class="hljs-params">(String beanName, DisposableBean bean)</span> </span>&#123;<br>  <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.disposableBeans) &#123;<br>    <span class="hljs-keyword">this</span>.disposableBeans.put(beanName, bean);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至此，整个 getBean的流程都已经走完了。</p>
<ul>
<li>循环依赖问题</li>
<li>后置处理器拓展问题</li>
<li>AOP的实现原理问题</li>
</ul>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>代号十三<br>
        <strong>本文链接：</strong><a href="https://code-13.github.io/blogs/cf22b3ec.html" title="https:&#x2F;&#x2F;code-13.github.io&#x2F;blogs&#x2F;cf22b3ec.html" target="_blank" rel="noopener">https:&#x2F;&#x2F;code-13.github.io&#x2F;blogs&#x2F;cf22b3ec.html</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Spring-framework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Spring-framework源码分析</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Spring/" rel="tag">Spring</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Spring-framework/" rel="tag">Spring-framework</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'f3372034aa4218f9f359',
        clientSecret: '235d14468b5af5837a9ff5e7b7541e93070cf602',
        id: window.location.pathname,
        repo: 'code-13.github.io',
        owner: 'code-13',
        admin: 'code-13'
    })
    gitalk.render('gitalk')
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#getBean"><span class="toc-number">1.</span> <span class="toc-text">getBean</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#doGetBean"><span class="toc-number">2.</span> <span class="toc-text">doGetBean()</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#doGetBean%E2%80%931"><span class="toc-number">2.1.</span> <span class="toc-text">doGetBean–1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#doGetBean%E2%80%932"><span class="toc-number">2.2.</span> <span class="toc-text">doGetBean–2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#doGetBean%E2%80%933"><span class="toc-number">2.3.</span> <span class="toc-text">doGetBean–3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#doGetBean%E2%80%934"><span class="toc-number">2.4.</span> <span class="toc-text">doGetBean–4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#doCreateBean"><span class="toc-number">2.5.</span> <span class="toc-text">doCreateBean</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#createBeanInstance-%E5%88%9B%E5%BB%BA-bean-%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.5.1.</span> <span class="toc-text">createBeanInstance 创建 bean 实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#obtainFromSupplier-%E5%AE%9E%E4%BE%8B%E6%8F%90%E4%BE%9B%E5%99%A8"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">obtainFromSupplier 实例提供器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#instantiateUsingFactoryMethod-%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">instantiateUsingFactoryMethod 工厂方法实例化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#determineConstructorsFromBeanPostProcessors"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">determineConstructorsFromBeanPostProcessors</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#autowireConstructor-%E6%9C%89%E5%8F%82%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">2.5.1.4.</span> <span class="toc-text">autowireConstructor 有参构造方法自动装配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#instantiateBean-%E6%97%A0%E5%8F%82%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.5.1.5.</span> <span class="toc-text">instantiateBean 无参构造方法实例化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#applyMergedBeanDefinitionPostProcessors"><span class="toc-number">2.5.2.</span> <span class="toc-text">applyMergedBeanDefinitionPostProcessors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#populateBean-%E5%B1%9E%E6%80%A7%E5%A1%AB%E5%85%85"><span class="toc-number">2.5.3.</span> <span class="toc-text">populateBean 属性填充</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#InstantiationAwareBeanPostProcessor"><span class="toc-number">2.5.3.1.</span> <span class="toc-text">InstantiationAwareBeanPostProcessor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.5.3.2.</span> <span class="toc-text">获取自动装配模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InstantiationAwareBeanPostProcessor-postProcessProperties"><span class="toc-number">2.5.3.3.</span> <span class="toc-text">InstantiationAwareBeanPostProcessor#postProcessProperties</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#initializeBean-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.5.4.</span> <span class="toc-text">initializeBean 初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#invokeAwareMethods"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">invokeAwareMethods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#applyBeanPostProcessorsBeforeInitialization"><span class="toc-number">2.5.4.2.</span> <span class="toc-text">applyBeanPostProcessorsBeforeInitialization</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invokeInitMethods-%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95"><span class="toc-number">2.5.4.3.</span> <span class="toc-text">invokeInitMethods 执行初始化方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#applyBeanPostProcessorsAfterInitialization"><span class="toc-number">2.5.4.4.</span> <span class="toc-text">applyBeanPostProcessorsAfterInitialization</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#registerDisposableBeanIfNecessary-%E9%94%80%E6%AF%81%E5%9B%9E%E8%B0%83"><span class="toc-number">2.5.5.</span> <span class="toc-text">registerDisposableBeanIfNecessary 销毁回调</span></a></li></ol></li></ol></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1640337217049"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
