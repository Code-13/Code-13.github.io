<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>Spring-framework源码分析（六）refresh方法 - 代号十三</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="code-13,代号十三">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" type="image/x-icon" />
    <meta name="description" content="refresh方法是Spring容器最核心的方法  概括了Spring初始化bean的整个生命周期 生命周期的回调 AOP Spring解决循环依赖的三级缓存">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring-framework源码分析（六）refresh方法">
<meta property="og:url" content="https://code-13.github.io/blogs/53ad1a77.html">
<meta property="og:site_name" content="代号十三">
<meta property="og:description" content="refresh方法是Spring容器最核心的方法  概括了Spring初始化bean的整个生命周期 生命周期的回调 AOP Spring解决循环依赖的三级缓存">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/2020/07/27/20200727174111.png">
<meta property="article:published_time" content="2020-07-28T08:53:00.000Z">
<meta property="article:modified_time" content="2021-12-24T09:12:03.509Z">
<meta property="article:author" content="代号十三">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="Spring-framework">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/2020/07/27/20200727174111.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1640337217050">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1640337217050">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/20200708225124.png)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="代号十三" class="mdui-btn mdui-btn-icon"><img src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" alt="代号十三"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="代号十三">
            <img src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" alt="代号十三" alt="代号十三">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>12</div>
        <div><span>标签</span>5</div>
        <div><span>分类</span>3</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="https://code-13.github.io/books" title="书海遨游">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                书海遨游
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:code-13.github.io" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/1504682" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/code-13/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JVM-内存分析/">JVM 内存分析</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/MapStruct/">MapStruct</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Spring-framework源码分析/">Spring-framework源码分析</a>
          <span class="category-list-count">9</span>
        </li>

        
      </ul>

    </div>
  </div>


    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/MAT/" style="font-size: 10px;">MAT</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/Spring-framework/" style="font-size: 20px;">Spring-framework</a> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 20px;">源码分析</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 代号十三
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br> 有点累
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 62.5%;"> 
              <img data-src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/2020/07/20/20200720195606.jpg" data-sizes="auto" alt="Spring-framework源码分析（六）refresh方法" class="lazyload">
              <h1>Spring-framework源码分析（六）refresh方法</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2020年07月28日</a>
    <a><i class="nexmoefont icon-areachart"></i>4.6k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 24 分钟</a>
</div>

      

      <p>refresh方法是Spring容器最核心的方法</p>
<ul>
<li>概括了Spring初始化bean的整个生命周期</li>
<li>生命周期的回调</li>
<li>AOP</li>
<li>Spring解决循环依赖的三级缓存</li>
</ul>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException </span>&#123;<br>		<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.startupShutdownMonitor) &#123;<br>    <span class="hljs-comment">// Prepare this context for refreshing.</span><br><br>    <span class="hljs-comment">//这里是做刷新bean工厂前的一系列赋值操作,主要是为前面创建的Spring工厂很多的属性都是空的，这个方式是为他做一些列的初始化值的操作！</span><br>    prepareRefresh();<br><br>    <span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.</span><br>    <span class="hljs-comment">//告诉子类刷新内部bean工厂 检测bean工厂是否存在 判断当前的bean工厂是否只刷新过一次，多次报错，返回当前使用的bean工厂,当该步骤为xml时 会新建一个新的工厂并返回</span><br>    ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();<br><br>    <span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br>    <span class="hljs-comment">//这里是初始化Spring的bean容器，向beanFactory内部注册一些自己本身内置的Bean后置处理器也就是通常说的BeanPostProcessor，这个方法其实也是再初始化工厂！</span><br>    prepareBeanFactory(beanFactory);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br>      <span class="hljs-comment">//允许在上下文子类中对bean工厂进行后处理,作用是在BeanFactory准备工作完成后做一些定制化的处理! 但是注意，你点进去是空方法，空方法以为着什么？意味着Spring的开发者希望调用者自定义扩展时使用！</span><br>      postProcessBeanFactory(beanFactory);<br><br>      <span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br>      <span class="hljs-comment">//其实相信看名字，大部分读者都能够猜出，他的目的是扫描非配置类的bd注册到工厂里面，扫描完成之后，开始执行所有的BeanFactoryPostProcessors，这里出现了第一个扩展点，自定义实现BeanFactoryPostProcessors的时候，他的回调时机是在Spring读取了全部的BeanDefinition之后调用的</span><br>      invokeBeanFactoryPostProcessors(beanFactory);<br><br>      <span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br>      <span class="hljs-comment">//这里是注册bean的后置处理器 也就是  beanPostProcessor 的实现 还有自己内置的处理器  注意这里并没有调用该处理器，只是将胡处理器注册进来bean工厂! 不知道大家使用过beanPostProcessor接口这个扩展点吗？他就是再这个方法里面被注册到Spring工厂里面的，当然注意一下，他只是注册进去了，并没有执行！记住并没有执行！</span><br>      registerBeanPostProcessors(beanFactory);<br><br>      <span class="hljs-comment">// Initialize message source for this context.</span><br>      <span class="hljs-comment">//国际化操作也就是 i18n的资源初始化</span><br>      initMessageSource();<br><br>      <span class="hljs-comment">// Initialize event multicaster for this context.</span><br>      <span class="hljs-comment">//Spring为我们提供了对于事件编程的封装，一般来说事件分为三个角色，事件广播器(发布事件)，事件监听器(监听事件)，事件源（具体的事件信息）三个角色,这个方法的目的就是初始化事件的广播器！</span><br>      initApplicationEventMulticaster();<br><br>      <span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br>      <span class="hljs-comment">//这里又是一个扩展点，内部的方法为空，Spring并没有实现它，供调用者实现！</span><br>      onRefresh();<br><br>      <span class="hljs-comment">// Check for listener beans and register them.</span><br>      <span class="hljs-comment">//注册Spring的事件监听器,上面已经说过了，这里是初始化并且注册事件监听器</span><br>      registerListeners();<br><br>      <span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>      <span class="hljs-comment">//这个方法是一个重点，他是为了实例化所有剩余的（非延迟初始化）单例。我们所说的bean的实例化，注入，解决循环依赖，回调beanPostProcessor等操作都是再这里实现的！</span><br>      finishBeanFactoryInitialization(beanFactory);<br><br>      <span class="hljs-comment">// Last step: publish corresponding event.</span><br>      <span class="hljs-comment">//最后一步：发布相应的事件。Spring内置的事件</span><br>      finishRefresh();<br>    &#125;<br><br>    <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>      <span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>        logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br>            <span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>      &#125;<br><br>      <span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>      destroyBeans();<br><br>      <span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>      cancelRefresh(ex);<br><br>      <span class="hljs-comment">// Propagate exception to caller.</span><br>      <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br><br>    <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br>      <span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>      resetCommonCaches();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>图解</p>
<p><img src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/2020/07/27/20200727174111.png"></p>
<h2 id="prepareRefresh"><a href="#prepareRefresh" class="headerlink" title="prepareRefresh()"></a>prepareRefresh()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareRefresh</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// Switch to active.</span><br>  <span class="hljs-comment">// 将容器激活</span><br><br>  <span class="hljs-comment">// 设置启动时间</span><br>  <span class="hljs-keyword">this</span>.startupDate = System.currentTimeMillis();<br>  <span class="hljs-comment">// 设置关闭状态</span><br>  <span class="hljs-keyword">this</span>.closed.set(<span class="hljs-keyword">false</span>);<br>  <span class="hljs-comment">// 设置激活状态</span><br>  <span class="hljs-keyword">this</span>.active.set(<span class="hljs-keyword">true</span>);<br><br>  <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Refreshing &quot;</span> + <span class="hljs-keyword">this</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      logger.debug(<span class="hljs-string">&quot;Refreshing &quot;</span> + getDisplayName());<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Initialize any placeholder property sources in the context environment.</span><br>  <span class="hljs-comment">// 子类自定义个性化的属性设置方法</span><br>  initPropertySources();<br><br>  <span class="hljs-comment">// Validate that all properties marked as required are resolvable:</span><br>  <span class="hljs-comment">// see ConfigurablePropertyResolver#setRequiredProperties</span><br><br>  <span class="hljs-comment">// 校验属性的合法</span><br>  getEnvironment().validateRequiredProperties();<br><br>  <span class="hljs-comment">// 保存早期的事件</span><br>  <span class="hljs-comment">// Store pre-refresh ApplicationListeners...</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.earlyApplicationListeners == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">this</span>.earlyApplicationListeners = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(<span class="hljs-keyword">this</span>.applicationListeners);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// Reset local application listeners to pre-refresh state.</span><br>    <span class="hljs-keyword">this</span>.applicationListeners.clear();<br>    <span class="hljs-keyword">this</span>.applicationListeners.addAll(<span class="hljs-keyword">this</span>.earlyApplicationListeners);<br>  &#125;<br><br>  <span class="hljs-comment">// Allow for the collection of early ApplicationEvents,</span><br>  <span class="hljs-comment">// to be published once the multicaster is available...</span><br>  <span class="hljs-keyword">this</span>.earlyApplicationEvents = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="obtainFreshBeanFactory"><a href="#obtainFreshBeanFactory" class="headerlink" title="obtainFreshBeanFactory()"></a>obtainFreshBeanFactory()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> ConfigurableListableBeanFactory <span class="hljs-title">obtainFreshBeanFactory</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// 刷新 BeanFactory</span><br>  refreshBeanFactory();<br>  <span class="hljs-keyword">return</span> getBeanFactory();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>GenericApplicationContext#refreshBeanFactory()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refreshBeanFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IllegalStateException </span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.refreshed.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<br>        <span class="hljs-string">&quot;GenericApplicationContext does not support multiple refresh attempts: just call &#x27;refresh&#x27; once&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 为 Bean工厂设置一个序列化Id</span><br>  <span class="hljs-keyword">this</span>.beanFactory.setSerializationId(getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="prepareBeanFactory-beanFactory"><a href="#prepareBeanFactory-beanFactory" class="headerlink" title="prepareBeanFactory(beanFactory)"></a>prepareBeanFactory(beanFactory)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Configure the factory&#x27;s standard context characteristics,</span><br><span class="hljs-comment">  * such as the context&#x27;s ClassLoader and post-processors.</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> beanFactory the BeanFactory to configure</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>  <span class="hljs-comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span><br><br>  <span class="hljs-comment">// 设置 类加载器</span><br>  beanFactory.setBeanClassLoader(getClassLoader());<br>  <span class="hljs-keyword">if</span> (!shouldIgnoreSpel) &#123;<br>    <span class="hljs-comment">// spel 表达式的解析器</span><br>    beanFactory.setBeanExpressionResolver(<span class="hljs-keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));<br>  &#125;<br>  beanFactory.addPropertyEditorRegistrar(<span class="hljs-keyword">new</span> ResourceEditorRegistrar(<span class="hljs-keyword">this</span>, getEnvironment()));<br><br>  <span class="hljs-comment">// Configure the bean factory with context callbacks.</span><br>  <span class="hljs-comment">// 添加 ApplicationContextAwareProcessor ，即 BeanPostProcessor</span><br>  beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationContextAwareProcessor(<span class="hljs-keyword">this</span>));<br><br>  <span class="hljs-comment">// 设置忽略自动专配的接口，这些接口的实现类不能通过接口来自动注入</span><br>  beanFactory.ignoreDependencyInterface(EnvironmentAware.class);<br>  beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);<br>  beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);<br>  beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);<br>  beanFactory.ignoreDependencyInterface(MessageSourceAware.class);<br>  beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);<br><br>  <span class="hljs-comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span><br>  <span class="hljs-comment">// MessageSource registered (and found for autowiring) as a bean.</span><br><br>  <span class="hljs-comment">// 注册可以解析的自动装配，即可以自动注入</span><br>  beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);<br>  beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="hljs-keyword">this</span>);<br>  beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="hljs-keyword">this</span>);<br>  beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="hljs-keyword">this</span>);<br><br>  <span class="hljs-comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span><br>  <span class="hljs-comment">// 添加 BeanPostProcessor ApplicationListenerDetector</span><br>  beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationListenerDetector(<span class="hljs-keyword">this</span>));<br><br>  <span class="hljs-comment">// 添加编译时的Aspectj依赖</span><br>  <span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span><br>  <span class="hljs-keyword">if</span> (!IN_NATIVE_IMAGE &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;<br>    beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));<br>    <span class="hljs-comment">// Set a temporary ClassLoader for type matching.</span><br>    beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));<br>  &#125;<br><br>  <span class="hljs-comment">// Register default environment beans.</span><br><br>  <span class="hljs-comment">// 给 BeanFactory 中注入一些组件</span><br>  <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;<br>    <span class="hljs-comment">// 注册 environment：： ConfigurableEnvironment</span><br>    beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;<br>    <span class="hljs-comment">// 注册 systemProperties ：： Map</span><br>    beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;<br>    <span class="hljs-comment">// 注册 systemEnvironment：：Map</span><br>    beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="postProcessBeanFactory-beanFactory"><a href="#postProcessBeanFactory-beanFactory" class="headerlink" title="postProcessBeanFactory(beanFactory)"></a>postProcessBeanFactory(beanFactory)</h2><p>AbstractApplicationContext#postProcessBeanFactory(beanFactory)是一个空方法，子类可以做一些特定的拓展</p>
<h2 id="invokeBeanFactoryPostProcessors-beanFactory"><a href="#invokeBeanFactoryPostProcessors-beanFactory" class="headerlink" title="invokeBeanFactoryPostProcessors(beanFactory)"></a>invokeBeanFactoryPostProcessors(beanFactory)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span><br><span class="hljs-comment">  * respecting explicit order if given.</span><br><span class="hljs-comment">  * &lt;p&gt;Must be called before singleton instantiation.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>  <span class="hljs-comment">// 拿到所有的 BeanFactoryPostProcessors ，并调用 PostProcessor 注册委托类执行</span><br>  PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());<br><br>  <span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span><br>  <span class="hljs-comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span><br>  <span class="hljs-keyword">if</span> (beanFactory.getTempClassLoader() == <span class="hljs-keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;<br>    beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));<br>    beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory, List<BeanFactoryPostProcessor>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">			ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;<br><br>  <span class="hljs-comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><br>  <span class="hljs-comment">// 用来保存已经执行过的后置处理器，避免重复执行</span><br>  Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br><br>  <span class="hljs-comment">// 先判断 beanFactory 是不是 BeanDefinitionRegistry</span><br>  <span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry) &#123;<br>    BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;<br><br>    <span class="hljs-comment">// 这个 List 是用来保存是 BeanFactoryPostProcessor 但不是 BeanDefinitionRegistryPostProcessor 的对象</span><br>    List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-comment">// 这个 List 是用来保存是 BeanDefinitionRegistryPostProcessor 但不是 BeanFactoryPostProcessor 的后置处理器对象</span><br>    List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>    <span class="hljs-comment">// 容器初始化调用时，beanFactoryPostProcessors 应该是空的</span><br>    <span class="hljs-comment">// 遍历所有的 beanFactoryPostProcessors</span><br>    <span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;<br>      <span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;<br><br>        <span class="hljs-comment">// 如果是 BeanDefinitionRegistryPostProcessor 就先执行 BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry</span><br>        <span class="hljs-comment">// 并把它加入到 registryProcessors 保存起来</span><br>        <span class="hljs-comment">// 先执行是为了 自定义 实现的 BeanDefinitionRegistryPostProcessor 会被最先执行</span><br>        BeanDefinitionRegistryPostProcessor registryProcessor =<br>            (BeanDefinitionRegistryPostProcessor) postProcessor;<br>        registryProcessor.postProcessBeanDefinitionRegistry(registry);<br>        registryProcessors.add(registryProcessor);<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//如果不是 BeanDefinitionRegistryPostProcessor 把就代表是 BeanFactoryPostProcessor 先保存起来</span><br>        regularPostProcessors.add(postProcessor);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br>    <span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br>    <span class="hljs-comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span><br>    <span class="hljs-comment">// PriorityOrdered, Ordered, and the rest.</span><br>    List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>    <span class="hljs-comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><br>    <span class="hljs-comment">// 首先 会先执行 实现了 PriorityOrdered 优先级排序接口的 BeanDefinitionRegistryPostProcessors</span><br><br>    <span class="hljs-comment">// 先从 容器中获取 所有的 BeanDefinitionRegistryPostProcessor 的 BeanDefinition 对象</span><br>    String[] postProcessorNames =<br>        beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br><br>    <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>      <span class="hljs-comment">// 如果是 PriorityOrdered</span><br>      <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>        <span class="hljs-comment">// 供容器中获取Bean，没有就会创建，然后加到 currentRegistryProcessors 中</span><br>        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>        processedBeans.add(ppName);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 先对 currentRegistryProcessors 进行排序</span><br>    sortPostProcessors(currentRegistryProcessors, beanFactory);<br>    <span class="hljs-comment">// 添加到 BeanDefinitionRegistryPostProcessor 集合中</span><br>    registryProcessors.addAll(currentRegistryProcessors);<br>    <span class="hljs-comment">// 然后执行</span><br>    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>    <span class="hljs-comment">//重要!!!!! 在这个过程中有一个非常重要的类 ConfigurationClassPostProcessor, 他实现了 BeanDefinitionRegistryPostProcessor 和 PriorityOrdered ，会被最先执行，他完成了全部的包扫描然后注册进入 BeanDefinition 中</span><br>    currentRegistryProcessors.clear();<br><br>    <span class="hljs-comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><br>    <span class="hljs-comment">// 然后执行实现了 Order 顺序接口的 BeanDefinitionRegistryPostProcessor, 步骤和上面 PriorityOrdered 的一摸一样</span><br>    postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>    <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>      <span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>        processedBeans.add(ppName);<br>      &#125;<br>    &#125;<br>    sortPostProcessors(currentRegistryProcessors, beanFactory);<br>    registryProcessors.addAll(currentRegistryProcessors);<br>    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>    currentRegistryProcessors.clear();<br><br>    <span class="hljs-comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><br>    <span class="hljs-comment">// 再然后执行没有实现排序接口的剩下的所有  BeanDefinitionRegistryPostProcessor, 步骤与上述一致</span><br>    <span class="hljs-keyword">boolean</span> reiterate = <span class="hljs-keyword">true</span>;<br>    <span class="hljs-keyword">while</span> (reiterate) &#123;<br>      reiterate = <span class="hljs-keyword">false</span>;<br>      postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>      <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>        <span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) &#123;<br>          currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>          processedBeans.add(ppName);<br>          reiterate = <span class="hljs-keyword">true</span>;<br>        &#125;<br>      &#125;<br>      sortPostProcessors(currentRegistryProcessors, beanFactory);<br>      registryProcessors.addAll(currentRegistryProcessors);<br>      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>      currentRegistryProcessors.clear();<br>    &#125;<br><br>    <span class="hljs-comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><br>    <span class="hljs-comment">// 执行 BeanDefinitionRegistryPostProcessor 接口中属于 BeanFactoryPostProcessor 的方法，因为 BeanDefinitionRegistryPostProcessor 继承了 BeanFactoryPostProcessor</span><br>    invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);<br>    <span class="hljs-comment">// 执行自定义的 BeanFactoryPostProcessor</span><br>    invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);<br>  &#125;<br><br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// Invoke factory processors registered with the context instance.</span><br>    <span class="hljs-comment">// 如果说 BeanFactory 没有实现 BeanDefinitionRegistry，那么它并不具有注册 BeanDefinition 的能力，所以只需要执行 BeanFactoryPostProcessor 即可</span><br>    invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);<br>  &#125;<br><br>  <span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br>  <span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br><br>  <span class="hljs-comment">// BeanDefinitionRegistryPostProcessor 执行完成之后，再去执行剩下的 BeanFactoryPostProcessor，执行步骤和上面的一摸一样</span><br><br>  String[] postProcessorNames =<br>      beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br><br>  <span class="hljs-comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span><br>  <span class="hljs-comment">// Ordered, and the rest.</span><br>  List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>    <span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) &#123;<br>      <span class="hljs-comment">// skip - already processed in first phase above</span><br>      <span class="hljs-comment">// 因为 BeanDefinitionRegistryPostProcessor 是 BeanFactoryPostProcessor 的子接口</span><br>      <span class="hljs-comment">// 所以当从容器中获取 BeanFactoryPostProcessor 的 BeanDefinition 对象时一定会有实现 BeanDefinitionRegistryPostProcessor 的对象</span><br>      <span class="hljs-comment">//但是 BeanDefinitionRegistryPostProcessor 再最开始已经执行过了，所以需要直接跳过</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>      priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>      orderedPostProcessorNames.add(ppName);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      nonOrderedPostProcessorNames.add(ppName);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span><br>  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>  invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);<br><br>  <span class="hljs-comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span><br>  List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());<br>  <span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;<br>    orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>  &#125;<br>  sortPostProcessors(orderedPostProcessors, beanFactory);<br>  invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);<br><br>  <span class="hljs-comment">// Finally, invoke all other BeanFactoryPostProcessors.</span><br>  List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());<br>  <span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;<br>    nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>  &#125;<br>  invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);<br><br>  <span class="hljs-comment">// Clear cached merged bean definitions since the post-processors might have</span><br>  <span class="hljs-comment">// modified the original metadata, e.g. replacing placeholders in values...</span><br>  beanFactory.clearMetadataCache();<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Invoke the given BeanDefinitionRegistryPostProcessor beans.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanDefinitionRegistryPostProcessors</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    Collection&lt;? extends BeanDefinitionRegistryPostProcessor&gt; postProcessors, BeanDefinitionRegistry registry)</span> </span>&#123;<br><br>  <span class="hljs-keyword">for</span> (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) &#123;<br>    postProcessor.postProcessBeanDefinitionRegistry(registry);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Invoke the given BeanFactoryPostProcessor beans.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    Collection&lt;? extends BeanFactoryPostProcessor&gt; postProcessors, ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br><br>  <span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : postProcessors) &#123;<br>    postProcessor.postProcessBeanFactory(beanFactory);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 <code>BeanDefinitionRegistryPostProcessor</code> 的实现类中，有一个类 <code>ConfigurationClassPostProcessor</code> 特别重要，他做了</p>
<ul>
<li>解析 <code>@Configuration</code></li>
<li>解析 <code>@ComponentScan</code></li>
<li>解析 <code>@Import</code></li>
<li>…等等重要的事情</li>
</ul>
<p>以后会重点解析这个类</p>
<h2 id="registerBeanPostProcessors-beanFactory"><a href="#registerBeanPostProcessors-beanFactory" class="headerlink" title="registerBeanPostProcessors(beanFactory)"></a>registerBeanPostProcessors(beanFactory)</h2><p>再一次强调一下，这里只是只是将处理器注册进来bean工厂，但是并未执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Instantiate and register all BeanPostProcessor beans,</span><br><span class="hljs-comment">  * respecting explicit order if given.</span><br><span class="hljs-comment">  * &lt;p&gt;Must be called before any instantiation of application beans.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>  <span class="hljs-comment">// 调用后置处理器委托类进行注册 BeanPostProcessor</span><br>  PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="hljs-keyword">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>PostProcessorRegistrationDelegate#registerBeanPostProcessors(ConfigurableListableBeanFactory, AbstractApplicationContext)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanPostProcessors</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">			ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;<br><br>  <span class="hljs-comment">// 获取所有的 BeanPostProcessor 的 beanDefinition 对象</span><br>  <span class="hljs-comment">// 先注册 PriorityOrdered 优先级接口，再注册 Ordered 排序接口的，最后注册没有实现任何优先级接口的，最后注册 MergedBeanDefinitionPostProcessor</span><br>  <span class="hljs-comment">// 注册就是 调用 beanFactory.addBeanPostProcessor(postProcessor)</span><br><br>  String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br><br>  <span class="hljs-comment">// Register BeanPostProcessorChecker that logs an info message when</span><br>  <span class="hljs-comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span><br>  <span class="hljs-comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span><br>  <span class="hljs-keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="hljs-number">1</span> + postProcessorNames.length;<br>  beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));<br><br>  <span class="hljs-comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span><br>  <span class="hljs-comment">// Ordered, and the rest.</span><br>  List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>    <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);<br>      priorityOrderedPostProcessors.add(pp);<br>      <span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>        internalPostProcessors.add(pp);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>      orderedPostProcessorNames.add(ppName);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      nonOrderedPostProcessorNames.add(ppName);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span><br>  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>  registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);<br><br>  <span class="hljs-comment">// Next, register the BeanPostProcessors that implement Ordered.</span><br>  List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());<br>  <span class="hljs-keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;<br>    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);<br>    orderedPostProcessors.add(pp);<br>    <span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>      internalPostProcessors.add(pp);<br>    &#125;<br>  &#125;<br>  sortPostProcessors(orderedPostProcessors, beanFactory);<br>  registerBeanPostProcessors(beanFactory, orderedPostProcessors);<br><br>  <span class="hljs-comment">// Now, register all regular BeanPostProcessors.</span><br>  List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());<br>  <span class="hljs-keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;<br>    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);<br>    nonOrderedPostProcessors.add(pp);<br>    <span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>      internalPostProcessors.add(pp);<br>    &#125;<br>  &#125;<br>  registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);<br><br>  <span class="hljs-comment">// Finally, re-register all internal BeanPostProcessors.</span><br>  sortPostProcessors(internalPostProcessors, beanFactory);<br>  registerBeanPostProcessors(beanFactory, internalPostProcessors);<br><br>  <span class="hljs-comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span><br>  <span class="hljs-comment">// moving it to the end of the processor chain (for picking up proxies etc).</span><br><br>  <span class="hljs-comment">//最后注册一个 ApplicationListenerDetector 来在 Bean 创建完成后检查是否是 ApplicationListener ,如果是，就向 applicationContext 中添加一个 监听器</span><br>  beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationListenerDetector(applicationContext));<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Register the given BeanPostProcessor beans.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanPostProcessors</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    ConfigurableListableBeanFactory beanFactory, List&lt;BeanPostProcessor&gt; postProcessors)</span> </span>&#123;<br><br>  <span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;<br>    <span class="hljs-comment">// Bulk addition is more efficient against our CopyOnWriteArrayList there</span><br>    ((AbstractBeanFactory) beanFactory).addBeanPostProcessors(postProcessors);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">for</span> (BeanPostProcessor postProcessor : postProcessors) &#123;<br>      beanFactory.addBeanPostProcessor(postProcessor);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="initMessageSource"><a href="#initMessageSource" class="headerlink" title="initMessageSource()"></a>initMessageSource()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Initialize the MessageSource.</span><br><span class="hljs-comment">  * Use parent&#x27;s if none defined in this context.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initMessageSource</span><span class="hljs-params">()</span> </span>&#123;<br>  ConfigurableListableBeanFactory beanFactory = getBeanFactory();<br>  <span class="hljs-keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;<br>    <span class="hljs-comment">// 如果有 ，赋值给 MessageSource 属性</span><br>    <span class="hljs-keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);<br>    <span class="hljs-comment">// Make MessageSource aware of parent MessageSource.</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parent != <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.messageSource <span class="hljs-keyword">instanceof</span> HierarchicalMessageSource) &#123;<br>      HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="hljs-keyword">this</span>.messageSource;<br>      <span class="hljs-keyword">if</span> (hms.getParentMessageSource() == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">// Only set parent context as parent MessageSource if no parent MessageSource</span><br>        <span class="hljs-comment">// registered already.</span><br>        hms.setParentMessageSource(getInternalParentMessageSource());<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Using MessageSource [&quot;</span> + <span class="hljs-keyword">this</span>.messageSource + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 没有创建一个 MessageSource, 并注册入容器中</span><br>    <span class="hljs-comment">// Use empty MessageSource to be able to accept getMessage calls.</span><br>    DelegatingMessageSource dms = <span class="hljs-keyword">new</span> DelegatingMessageSource();<br>    dms.setParentMessageSource(getInternalParentMessageSource());<br>    <span class="hljs-keyword">this</span>.messageSource = dms;<br>    beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="hljs-keyword">this</span>.messageSource);<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;No &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="hljs-string">&quot;&#x27; bean, using [&quot;</span> + <span class="hljs-keyword">this</span>.messageSource + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster()"></a>initApplicationEventMulticaster()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Initialize the ApplicationEventMulticaster.</span><br><span class="hljs-comment">  * Uses SimpleApplicationEventMulticaster if none defined in the context.</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@see</span> org.springframework.context.event.SimpleApplicationEventMulticaster</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initApplicationEventMulticaster</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// 获取 BeanFactory</span><br>  <span class="hljs-comment">// 判断容器中是否有 applicationEventMulticaster 组件，有就取出，没有就新建一个 SimpleApplicationEventMulticaster 并注册进容器中</span><br>  ConfigurableListableBeanFactory beanFactory = getBeanFactory();<br>  <span class="hljs-keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;<br>    <span class="hljs-keyword">this</span>.applicationEventMulticaster =<br>        beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="hljs-keyword">this</span>.applicationEventMulticaster + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">this</span>.applicationEventMulticaster = <span class="hljs-keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);<br>    beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="hljs-keyword">this</span>.applicationEventMulticaster);<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="hljs-string">&quot;&#x27; bean, using &quot;</span> +<br>          <span class="hljs-string">&quot;[&quot;</span> + <span class="hljs-keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="onRefresh-方法"><a href="#onRefresh-方法" class="headerlink" title="onRefresh()方法"></a>onRefresh()方法</h2><p>仍然是个空方法，供子类拓展实现</p>
<h2 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners()"></a>registerListeners()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Add beans that implement ApplicationListener as listeners.</span><br><span class="hljs-comment">  * Doesn&#x27;t affect other listeners, which can be added without being beans.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerListeners</span><span class="hljs-params">()</span> </span>&#123;<br><br>  <span class="hljs-comment">// 先注册 指定的 Listener</span><br>  <span class="hljs-comment">// Register statically specified listeners first.</span><br>  <span class="hljs-keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;<br>    getApplicationEventMulticaster().addApplicationListener(listener);<br>  &#125;<br><br>  <span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br>  <span class="hljs-comment">// uninitialized to let post-processors apply to them!</span><br><br>  <span class="hljs-comment">// 从容器内获取 所有 ApplicationListener 的 beanDefinition ，把他们添加到派发器中</span><br>  String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>  <span class="hljs-keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;<br>    getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);<br>  &#125;<br><br>  <span class="hljs-comment">// Publish early application events now that we finally have a multicaster...</span><br>  <span class="hljs-comment">// 发布早期事件</span><br>  Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="hljs-keyword">this</span>.earlyApplicationEvents;<br>  <span class="hljs-keyword">this</span>.earlyApplicationEvents = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(earlyEventsToProcess)) &#123;<br>    <span class="hljs-keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;<br>      getApplicationEventMulticaster().multicastEvent(earlyEvent);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="finishBeanFactoryInitialization-beanFactory"><a href="#finishBeanFactoryInitialization-beanFactory" class="headerlink" title="finishBeanFactoryInitialization(beanFactory)"></a>finishBeanFactoryInitialization(beanFactory)</h2><p>这个方法是一个重点，他是为了实例化所有剩余的（非延迟初始化）单例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Finish the initialization of this context&#x27;s bean factory,</span><br><span class="hljs-comment">  * initializing all remaining singleton beans.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>  <span class="hljs-comment">// Initialize conversion service for this context.</span><br>  <span class="hljs-comment">// 实例化 类型转换组件</span><br>  <span class="hljs-keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;<br>      beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;<br>    beanFactory.setConversionService(<br>        beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));<br>  &#125;<br><br>  <span class="hljs-comment">// Register a default embedded value resolver if no bean post-processor</span><br>  <span class="hljs-comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span><br>  <span class="hljs-comment">// at this point, primarily for resolution in annotation attribute values.</span><br>  <span class="hljs-comment">// 实例化值解析器</span><br>  <span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;<br>    beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));<br>  &#125;<br><br>  <span class="hljs-comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br>  String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>  <span class="hljs-keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;<br>    getBean(weaverAwareName);<br>  &#125;<br><br>  <span class="hljs-comment">// Stop using the temporary ClassLoader for type matching.</span><br>  beanFactory.setTempClassLoader(<span class="hljs-keyword">null</span>);<br><br>  <span class="hljs-comment">// Allow for caching all bean definition metadata, not expecting further changes.</span><br>  beanFactory.freezeConfiguration();<br><br>  <span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>  <span class="hljs-comment">// 初始化剩下的所有的单实例Bean</span><br>  beanFactory.preInstantiateSingletons();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>会调用 DefaultListableBeanFactory#preInstantiateSingletons 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>    logger.trace(<span class="hljs-string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="hljs-keyword">this</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span><br>  <span class="hljs-comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span><br>  <span class="hljs-comment">// 将所有的BeanDefinition的name信息加载到一个副本中</span><br>  List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-keyword">this</span>.beanDefinitionNames);<br><br>  <span class="hljs-comment">// 遍历所有的 BeanDefinition 的 name</span><br>  <span class="hljs-comment">// Trigger initialization of all non-lazy singleton beans...</span><br>  <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>    <span class="hljs-comment">// 获取 BeanDefinition</span><br>    RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);<br><br>    <span class="hljs-comment">// 如果不是 抽象的 并且是 单例的 并且 不是懒加载的</span><br>    <span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;<br><br>      <span class="hljs-comment">// 当前 bean 是不是 工厂方法</span><br>      <span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;<br>        Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);<br>        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> FactoryBean) &#123;<br>          FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;<br>          <span class="hljs-keyword">boolean</span> isEagerInit;<br>          <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;<br>            isEagerInit = AccessController.doPrivileged(<br>                (PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,<br>                getAccessControlContext());<br>          &#125;<br>          <span class="hljs-keyword">else</span> &#123;<br>            isEagerInit = (factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp;<br>                ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());<br>          &#125;<br>          <span class="hljs-keyword">if</span> (isEagerInit) &#123;<br>            <span class="hljs-comment">// 判断 工厂方法 需不需要马上初始化，如果是 getBean</span><br>            getBean(beanName);<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 不是工厂方法，直接 getBean</span><br>        getBean(beanName);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 所有Bean都利用getBean创建完成之后</span><br>  <span class="hljs-comment">// 检查Bean是不是 SmartInitializingSingleton 接口，如果是 就执行 afterSingletonsInstantiated 方法</span><br>  <span class="hljs-comment">// Trigger post-initialization callback for all applicable beans...</span><br>  <span class="hljs-comment">// 触发 Bean 初始化 之后 回调</span><br>  <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>    Object singletonInstance = getSingleton(beanName);<br>    <span class="hljs-keyword">if</span> (singletonInstance <span class="hljs-keyword">instanceof</span> SmartInitializingSingleton) &#123;<br>      SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;<br>      <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;<br>        AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>          smartSingleton.afterSingletonsInstantiated();<br>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;, getAccessControlContext());<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        smartSingleton.afterSingletonsInstantiated();<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由此可以看出 getBean()方法是创建 Bean 的核心方法，bean的声明周期的各项回调以及BeanPostProcessor的调用均在此处</p>
<h2 id="finishRefresh"><a href="#finishRefresh" class="headerlink" title="finishRefresh()"></a>finishRefresh()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Finish the refresh of this context, invoking the LifecycleProcessor&#x27;s</span><br><span class="hljs-comment">  * onRefresh() method and publishing the</span><br><span class="hljs-comment">  * &#123;<span class="hljs-doctag">@link</span> org.springframework.context.event.ContextRefreshedEvent&#125;.</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finishRefresh</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span><br>  clearResourceCaches();<br><br>  <span class="hljs-comment">// Initialize lifecycle processor for this context.</span><br>  <span class="hljs-comment">// 初始化生命周期有关的处理器</span><br>  initLifecycleProcessor();<br><br>  <span class="hljs-comment">// Propagate refresh to lifecycle processor first.</span><br>  <span class="hljs-comment">// 拿到 上一步定义的生命周期处理器，回调 onRefresh()方法</span><br>  getLifecycleProcessor().onRefresh();<br><br>  <span class="hljs-comment">// Publish the final event.</span><br>  <span class="hljs-comment">// 发布容器刷新完成事件</span><br>  publishEvent(<span class="hljs-keyword">new</span> ContextRefreshedEvent(<span class="hljs-keyword">this</span>));<br><br>  <span class="hljs-comment">// Participate in LiveBeansView MBean, if active.</span><br>  <span class="hljs-keyword">if</span> (!IN_NATIVE_IMAGE) &#123;<br>    LiveBeansView.registerApplicationContext(<span class="hljs-keyword">this</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Initialize the LifecycleProcessor.</span><br><span class="hljs-comment">  * Uses DefaultLifecycleProcessor if none defined in the context.</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@see</span> org.springframework.context.support.DefaultLifecycleProcessor</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initLifecycleProcessor</span><span class="hljs-params">()</span> </span>&#123;<br><br>  <span class="hljs-comment">// 从容器中找是否有生命周期组件，有就赋值，没有就新建一个 DefaultLifecycleProcessor ,加入到容器中</span><br><br>  ConfigurableListableBeanFactory beanFactory = getBeanFactory();<br>  <span class="hljs-keyword">if</span> (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;<br>    <span class="hljs-keyword">this</span>.lifecycleProcessor =<br>        beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Using LifecycleProcessor [&quot;</span> + <span class="hljs-keyword">this</span>.lifecycleProcessor + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    DefaultLifecycleProcessor defaultProcessor = <span class="hljs-keyword">new</span> DefaultLifecycleProcessor();<br>    defaultProcessor.setBeanFactory(beanFactory);<br>    <span class="hljs-keyword">this</span>.lifecycleProcessor = defaultProcessor;<br>    beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, <span class="hljs-keyword">this</span>.lifecycleProcessor);<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;No &#x27;&quot;</span> + LIFECYCLE_PROCESSOR_BEAN_NAME + <span class="hljs-string">&quot;&#x27; bean, using &quot;</span> +<br>          <span class="hljs-string">&quot;[&quot;</span> + <span class="hljs-keyword">this</span>.lifecycleProcessor.getClass().getSimpleName() + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至此，容器刷新完成</p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>代号十三<br>
        <strong>本文链接：</strong><a href="https://code-13.github.io/blogs/53ad1a77.html" title="https:&#x2F;&#x2F;code-13.github.io&#x2F;blogs&#x2F;53ad1a77.html" target="_blank" rel="noopener">https:&#x2F;&#x2F;code-13.github.io&#x2F;blogs&#x2F;53ad1a77.html</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Spring-framework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Spring-framework源码分析</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Spring/" rel="tag">Spring</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Spring-framework/" rel="tag">Spring-framework</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'f3372034aa4218f9f359',
        clientSecret: '235d14468b5af5837a9ff5e7b7541e93070cf602',
        id: window.location.pathname,
        repo: 'code-13.github.io',
        owner: 'code-13',
        admin: 'code-13'
    })
    gitalk.render('gitalk')
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#prepareRefresh"><span class="toc-number">1.</span> <span class="toc-text">prepareRefresh()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#obtainFreshBeanFactory"><span class="toc-number">2.</span> <span class="toc-text">obtainFreshBeanFactory()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prepareBeanFactory-beanFactory"><span class="toc-number">3.</span> <span class="toc-text">prepareBeanFactory(beanFactory)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#postProcessBeanFactory-beanFactory"><span class="toc-number">4.</span> <span class="toc-text">postProcessBeanFactory(beanFactory)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#invokeBeanFactoryPostProcessors-beanFactory"><span class="toc-number">5.</span> <span class="toc-text">invokeBeanFactoryPostProcessors(beanFactory)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#registerBeanPostProcessors-beanFactory"><span class="toc-number">6.</span> <span class="toc-text">registerBeanPostProcessors(beanFactory)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#initMessageSource"><span class="toc-number">7.</span> <span class="toc-text">initMessageSource()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#initApplicationEventMulticaster"><span class="toc-number">8.</span> <span class="toc-text">initApplicationEventMulticaster()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#onRefresh-%E6%96%B9%E6%B3%95"><span class="toc-number">9.</span> <span class="toc-text">onRefresh()方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#registerListeners"><span class="toc-number">10.</span> <span class="toc-text">registerListeners()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#finishBeanFactoryInitialization-beanFactory"><span class="toc-number">11.</span> <span class="toc-text">finishBeanFactoryInitialization(beanFactory)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#finishRefresh"><span class="toc-number">12.</span> <span class="toc-text">finishRefresh()</span></a></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1640337217059"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
