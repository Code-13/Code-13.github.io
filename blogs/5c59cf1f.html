<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>JVM 内存分析工具 MAT 的深度讲解与实践——进阶篇(转载) - 代号十三</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="code-13,代号十三">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" type="image/x-icon" />
    <meta name="description" content="原文作者：https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;1275089220539869原文作者公众号： Q的博客。原文链接：https:&#x2F;&#x2F;juejin.cn&#x2F;post&#x2F;6911624328472133646  本系列共三篇文章， 本文是系列第2篇——进阶篇，详细讲解 MAT 各种工具的核心功能、用法、适用场景，并在具体实战场景下讲解帮大家学习如何针对各类内存问题。    《JVM 内存分析工">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM 内存分析工具 MAT 的深度讲解与实践——进阶篇(转载)">
<meta property="og:url" content="https://code-13.github.io/blogs/5c59cf1f.html">
<meta property="og:site_name" content="代号十三">
<meta property="og:description" content="原文作者：https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;1275089220539869原文作者公众号： Q的博客。原文链接：https:&#x2F;&#x2F;juejin.cn&#x2F;post&#x2F;6911624328472133646  本系列共三篇文章， 本文是系列第2篇——进阶篇，详细讲解 MAT 各种工具的核心功能、用法、适用场景，并在具体实战场景下讲解帮大家学习如何针对各类内存问题。    《JVM 内存分析工">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8bb5e21bfb5a4a4d855e5e0ee80206d7~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/822515f03c704e61ae8967048a36b4b3~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cdfda3beda914ae288b96f261d0e58ca~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/542dac8375904537b24c22c7d9f1ff73~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2398433f51d44bc193f5ff52b7ae3359~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c4dd3d11eb4424bb034507e5c18afad~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/565744afcf404deb9fd14ea7282cbc1d~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67954d39202b407e8c2e36fa471cdcf4~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d6f2ec751aa484ab8e5586465ab4f88~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b26e5c1700924cadbaae240c92c50547~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95bd5af74fb640c5bef9eb2deacbbf44~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4cdfc1b12ac47cd8ffb739b68a77d0b~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a19c8ccf2ed44a0ae4150884665a0f6~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c3d2e9807374c608857ae03ddb42709~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fe24e47a05042b7b61a103e3c7dbf4b~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d953a502fdf40c6ad95a5a992ec33fb~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc64b31b8e484ca88e02590b42f82c74~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf60312fd4894df98ccd7573a1c0c5c6~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9309e3ecfa4e48dc8b98ab2f1e4e08d6~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3dad1e14bad84ced8f906bf162dad4c5~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09f7a1ecbe1d495cb144c16f676f9888~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8128a34a4fb42a7a28d4f7c69313e12~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64fac354fd204b3f93c43d48a25c0646~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bde68d299620415cb34f5d6cbbeeeae7~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfcded48fb234e0682bdc6d872f03717~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3919a0973e6f4ac0b4fe3460e24fec75~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60fbe324fe9d416c90c2e659b4f971c7~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cdae3fc7b614c01a8047e3c024b4680~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db89543ca6b544cf8e36252aa08a60be~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3be497af48b4c5b9ea96b2ae2a9c967~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5067f8c3bc94397ad829ae9ee882b34~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/409f4fd84bef43dfabdd9f6337615917~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2f44f9216f94b08bc3bdf7107d5a737~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de3c98f88cf14561ae1117e2f8e55cd2~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44000e6e5c2946e18ed1703d68aec244~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad7db951d8254ebaa9c85f07e799f887~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fe6c558fd665443c874d41c920a64018~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef6b45a0681c4976a0fd59ba31de6243~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99960e293cf742b3b60f90095d2c56f8~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffe93f29a7cc499795279070ed3edb25~tplv-k3u1fbpfcp-watermark.image">
<meta property="article:published_time" content="2021-08-20T07:35:55.000Z">
<meta property="article:modified_time" content="2021-12-24T09:12:03.509Z">
<meta property="article:author" content="代号十三">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="MAT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8bb5e21bfb5a4a4d855e5e0ee80206d7~tplv-k3u1fbpfcp-watermark.image">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1640337216898">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1640337216898">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/20200708225124.png)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="代号十三" class="mdui-btn mdui-btn-icon"><img src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" alt="代号十三"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="代号十三">
            <img src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/avatar.jpg" alt="代号十三" alt="代号十三">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>12</div>
        <div><span>标签</span>5</div>
        <div><span>分类</span>3</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="https://code-13.github.io/books" title="书海遨游">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                书海遨游
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:code-13.github.io" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/1504682" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/code-13/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JVM-内存分析/">JVM 内存分析</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/MapStruct/">MapStruct</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Spring-framework源码分析/">Spring-framework源码分析</a>
          <span class="category-list-count">9</span>
        </li>

        
      </ul>

    </div>
  </div>


    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/MAT/" style="font-size: 10px;">MAT</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/Spring-framework/" style="font-size: 20px;">Spring-framework</a> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 20px;">源码分析</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 代号十三
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br> 有点累
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: NaN%;"> 
              <img data-src="https://cdn.jsdelivr.net/gh/code-13/cloudimage/images/2021/08/20/20210820152607.png" data-sizes="auto" alt="JVM 内存分析工具 MAT 的深度讲解与实践——进阶篇(转载)" class="lazyload">
              <h1>JVM 内存分析工具 MAT 的深度讲解与实践——进阶篇(转载)</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2021年08月20日</a>
    <a><i class="nexmoefont icon-areachart"></i>6.1k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 27 分钟</a>
</div>

      

      <blockquote>
<p>原文作者：<a target="_blank" rel="noopener" href="https://juejin.cn/user/1275089220539869">https://juejin.cn/user/1275089220539869</a><br>原文作者公众号： <strong>Q的博客。</strong><br>原文链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6911624328472133646">https://juejin.cn/post/6911624328472133646</a></p>
</blockquote>
<p><strong>本系列共三篇文章，</strong> 本文是系列第2篇——进阶篇，详细讲解 MAT 各种工具的<strong>核心功能、用法、适用场景</strong>，并在具体实战场景下讲解帮大家学习如何针对各类内存问题。</p>
<ul>
<li>  《<a target="_blank" rel="noopener" href="https://juejin.cn/post/6908665391136899079" title="https://juejin.cn/post/6908665391136899079">JVM 内存分析工具 MAT 的深度讲解与实践——入门篇</a>》 介绍 MAT 产品功能、基础概念、与其他工具对比、Quick Start 指南。</li>
<li>  <strong>《JVM 内存分析工具 MAT 的深度讲解与实践——进阶篇》</strong> 展开并详细讲解 MAT 各种工具的核心功能、用法、场景，并在具体实战场景下讲解帮大家加深体会。</li>
<li>  《JVM 内存分析工具 MAT 的深度讲解与实践——高阶篇》 总结复杂内存问题的系统性分析方法，并通过一个综合案例提升大家的实战能力。</li>
</ul>
<span id="more"></span>

<hr>
<p>熟练掌握 MAT 是 Java 高手的必备能力，但实践时大家往往需面对众多功能，眼花缭乱不知如何下手，小编也没有找到一篇完善的教学素材，所以整理本文帮大家系统掌握 MAT 分析工具。</p>
<p>本文详细讲解 MAT 众多内存分析工具功能，这些功能组合使用异常强大，熟练使用几乎可以解决所有的堆内存离线分析的问题。我们将功能划分为4类：内存分布详情、对象间依赖、对象状态详情、按条件检索。每大类有多个功能点，本文会逐一讲解各功能的场景及用法。此外，添加了原创或引用案例加强理解和掌握。</p>
<p>注：在该系列开篇文章《<a target="_blank" rel="noopener" href="https://juejin.cn/post/6908665391136899079" title="https://juejin.cn/post/6908665391136899079">JVM 内存分析工具 MAT 的深度讲解与实践——入门篇</a>》中介绍了 MAT 的使用场景及安装方法，不熟悉 MAT 的读者建议先阅读上文并安装，本文案例很容易在本地实践。另外，上文中产品介绍部分顺序也对应本文功能讲解的组织，如下图： <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8bb5e21bfb5a4a4d855e5e0ee80206d7~tplv-k3u1fbpfcp-watermark.image"><br> 为减少对眼花缭乱的菜单的迷茫，可以通过下图先整体熟悉下各功能使用入口，后续都会讲到。 <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/822515f03c704e61ae8967048a36b4b3~tplv-k3u1fbpfcp-watermark.image"></p>
<h2 id="2-1-全局信息概览"><a href="#2-1-全局信息概览" class="headerlink" title="2.1 全局信息概览"></a>2.1 全局信息概览</h2><p><strong>功能</strong>：展现堆内存大小、对象数量、class 数量、class loader 数量、GC Root 数量、环境变量、线程概况等全局统计信息。</p>
<p><strong>使用入口</strong>：MAT 主界面 → Heap Dump Overview。</p>
<p><strong>举例</strong>：下面是对象数量、class loader 数量、GC Root 数量，可以看出 class loader 存在异常。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cdfda3beda914ae288b96f261d0e58ca~tplv-k3u1fbpfcp-watermark.image"></p>
<p><strong>举例</strong>：下图是线程概况，可以查看每个线程名、线程的 Retained Heap、daemon 属性等。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/542dac8375904537b24c22c7d9f1ff73~tplv-k3u1fbpfcp-watermark.image"></p>
<p><strong>使用场景</strong> 全局概览呈现全局统计信息，重点查看整体是否有异常数据，所以有效信息有限，下面几种场景有一定帮助：</p>
<ul>
<li>  方法区溢出时（Java 8后不使用方法区，对应堆溢出），查看 class 数量异常多，可以考虑是否为动态代理类异常载入过多或类被反复重复加载。</li>
<li>  方法区溢出时，查看 class loader 数量过多，可以考虑是否为自定义 class loader 被异常循环使用。</li>
<li>  GC Root 过多，可以查看 GC Root 分布，理论上这种情况极少会遇到，笔者只在 JNI 使用一个存在 BUG 的库时遇到过。</li>
<li>  线程数过多，一般是频繁创建线程但无法执行结束，从概览可以了解异常表象，具体原因可以参考本文线程分析部分内容，此处不展开。</li>
</ul>
<h2 id="2-2-Dominator-tree"><a href="#2-2-Dominator-tree" class="headerlink" title="2.2 Dominator tree"></a>2.2 Dominator tree</h2><p>_<strong>注：笔者使用频率的 Top1，是高效分析 Dump 必看的功能。</strong> _</p>
<p><strong>功能</strong></p>
<ul>
<li>  展现对象的支配关系图，并给出对象支配内存的大小（支配内存等同于 Retained Heap，即其被 GC 回收可释放的内存大小）</li>
<li>  支持排序、支持按 package、class loader、super class、class 聚类统计</li>
</ul>
<p><strong>使用入口</strong>：全局支配树： MAT 主界面 → Dominator tree。</p>
<p><strong>举例：</strong>  下图中通过查看 Dominator tree，了解到内存主要是由 ThreadAndListHolder-thread 及 main 两个线程支配（后面第2.6节会给出整体案例）。</p>
<ul>
<li><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2398433f51d44bc193f5ff52b7ae3359~tplv-k3u1fbpfcp-watermark.image"></li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>开始 Dump 分析时，首先应使用 Dominator tree 了解各支配树起点对象所支配内存的大小，进而了解哪几个起点对象是 GC 无法释放大内存的原因。</li>
<li>当个别对象支配树的 Retained Heap 很大存在明显倾斜时，可以重点分析占比高的对象支配关系，展开子树进一步定位到问题根因，如下图中可看出最终是 SameContentWrapperContainer 对象持有的 ArrayList 过大。  <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c4dd3d11eb4424bb034507e5c18afad~tplv-k3u1fbpfcp-watermark.image"></li>
<li>在 Dominator tree 中展开树状图，可以查看支配关系路径（与 outgoing reference 的区别是：如果 X 支配 Y，则 X 释放后 Y必然可释放；如果仅仅是 X 引用 Y，可能仍有其他对象引用 Y，X 释放后 Y 仍不能释放，所以 Dominator tree 去除了 incoming reference 中大量的冗余信息）。</li>
<li>有些情况下可能并没有支配起点对象的 Retained Heap 占用很大内存（比如 class X 有100个对象，每个对象的 Retained Heap 是10M，则 class X 所有对象实际支配的内存是 1G，但可能 Dominator tree 的前20个都是其他class 的对象），这时可以按 class、package、class loader 做聚合，进而定位目标。<ul>
<li>下图中各 GC Roots 所支配的内存均不大，这时需要聚合定位爆发点。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/565744afcf404deb9fd14ea7282cbc1d~tplv-k3u1fbpfcp-watermark.image"></li>
<li>在 Dominator tree 展现后按 class 聚合，如下图： <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67954d39202b407e8c2e36fa471cdcf4~tplv-k3u1fbpfcp-watermark.image"></li>
<li>可以定位到是 SomeEntry 对象支配内存较多，然后结合代码进一步分析具体原因。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d6f2ec751aa484ab8e5586465ab4f88~tplv-k3u1fbpfcp-watermark.image"></li>
</ul>
</li>
<li>在一些操作后定位到异常持有 Retained Heap 对象后（如从代码看对象应该被回收），可以获取对象的直接支配者，操作方式如下。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b26e5c1700924cadbaae240c92c50547~tplv-k3u1fbpfcp-watermark.image"></li>
</ul>
<h2 id="2-3-Histogram-直方图"><a href="#2-3-Histogram-直方图" class="headerlink" title="2.3 Histogram 直方图"></a>2.3 Histogram 直方图</h2><p><em><strong>注：笔者使用频率 Top2</strong></em></p>
<p><strong>功能</strong></p>
<ul>
<li>  罗列每个类实例的数量、类实例累计内存占比，包括自身内存占用量（Shallow Heap）及支配对象的内存占用量（Retain Heap）。</li>
<li>  支持按对象数量、Retained Heap、Shallow Heap（默认排序）等指标排序；支持按正则过滤；支持按 package、class loader、super class、class 聚类统计，</li>
</ul>
<p><strong>使用入口</strong>：MAT 主界面 → Histogram；注意 Histogram 默认不展现 Retained Heap，可以使用计算器图标计算，如下图所示。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95bd5af74fb640c5bef9eb2deacbbf44~tplv-k3u1fbpfcp-watermark.image"></p>
<p><strong>使用场景</strong></p>
<ul>
<li>  有些情况 Dominator tree 无法展现出热点对象（上文提到 Dominator tree 支配内存排名前20的占比均不高，或者按 class 聚合也无明显热点对象，此时 Dominator tree 很难做关联分析判断哪类对象占比高），这时可以使用 Histogram 查看所有对象所属类的分布，快速定位占据 Retained Heap 大头的类。</li>
<li>  使用技巧</li>
</ul>
<h2 id="2-4-Leak-Suspects"><a href="#2-4-Leak-Suspects" class="headerlink" title="2.4 Leak Suspects"></a>2.4 Leak Suspects</h2><p><strong>功能</strong>：具备自动检测内存泄漏功能，罗列可能存在内存泄漏的问题点。</p>
<p><strong>使用入口</strong>：一般当存在明显的内存泄漏时，分析完Dump文件后就会展现，也可以如下图在 MAT 主页 → Leak Suspects。</p>
<p><strong>使用场景</strong>：需要查看引用链条上占用内存较多的可疑对象。这个功能可解决一些基础问题，但复杂的问题往往帮助有限。</p>
<p><strong>举例</strong></p>
<ul>
<li>下图中 Leak Suspects 视图展现了两个线程支配了绝大部分内存。  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4cdfc1b12ac47cd8ffb739b68a77d0b~tplv-k3u1fbpfcp-watermark.image"></li>
<li>下图是点击上图中 Keywords 中 “Details” ,获取实例到 GC Root 的最短路径、dominator 路径的细信息。 <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a19c8ccf2ed44a0ae4150884665a0f6~tplv-k3u1fbpfcp-watermark.image"></li>
</ul>
<h2 id="2-5-Top-Consumers"><a href="#2-5-Top-Consumers" class="headerlink" title="2.5 Top Consumers"></a>2.5 Top Consumers</h2><p><strong>功能</strong>：最大对象报告，可以展现哪些类、哪些 class loader、哪些 package 占用最高比例的内存，其功能 Histogram 及 Dominator tree 也都支持。</p>
<p><strong>使用场景</strong>：应用程序发生内存泄漏时，查看哪些泄漏的对象通常在 Dump 快照中会占很大的比重。因此，对简单的问题具有较高的价值。</p>
<h2 id="2-6-综合案例一"><a href="#2-6-综合案例一" class="headerlink" title="2.6 综合案例一"></a>2.6 综合案例一</h2><p><strong>使用工具项</strong>：Heap dump overview、Dominator tree、Histogram、Class Loader Explorer（见3.4节）、incoming references（见3.1节）</p>
<p><strong>程序代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.q.mat;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> org.objectweb.asm.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderOOMOps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Opcodes</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String args[])</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">new</span> ThreadAndListHolder(); <br><br>        List&lt;ClassLoader&gt; classLoaders = <span class="hljs-keyword">new</span> ArrayList&lt;ClassLoader&gt;();<br>        <span class="hljs-keyword">final</span> String className = <span class="hljs-string">&quot;ClassLoaderOOMExample&quot;</span>;<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] code = geneDynamicClassBytes(className);<br><br>        <br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>            ClassLoaderOOMOps loader = <span class="hljs-keyword">new</span> ClassLoaderOOMOps();<br>            Class&lt;?&gt; exampleClass = loader.defineClass(className, code, <span class="hljs-number">0</span>, code.length); <br>            classLoaders.add(loader);<br>            <br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] geneDynamicClassBytes(String className) <span class="hljs-keyword">throws</span> Exception &#123;<br>        ClassWriter cw = <span class="hljs-keyword">new</span> ClassWriter(<span class="hljs-number">0</span>);<br>        cw.visit(V1_1, ACC_PUBLIC, className, <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;java/lang/Object&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <br>        MethodVisitor mw = cw.visitMethod(ACC_PUBLIC, <span class="hljs-string">&quot;&lt;init&gt;&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br><br>        <br>        mw.visitVarInsn(ALOAD, <span class="hljs-number">0</span>);<br>        mw.visitMethodInsn(INVOKESPECIAL, <span class="hljs-string">&quot;java/lang/Object&quot;</span>, <span class="hljs-string">&quot;&lt;init&gt;&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>);<br>        mw.visitInsn(RETURN);<br>        mw.visitMaxs(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>        mw.visitEnd();<br><br>        <br>        mw = cw.visitMethod(ACC_PUBLIC + ACC_STATIC, <span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-string">&quot;([Ljava/lang/String;)V&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>        <br>        mw.visitFieldInsn(GETSTATIC, <span class="hljs-string">&quot;java/lang/System&quot;</span>, <span class="hljs-string">&quot;out&quot;</span>, <span class="hljs-string">&quot;Ljava/io/PrintStream;&quot;</span>);<br><br>        mw.visitLdcInsn(<span class="hljs-string">&quot;Hello world!&quot;</span>);<br>        mw.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string">&quot;java/io/PrintStream&quot;</span>, <span class="hljs-string">&quot;println&quot;</span>, <span class="hljs-string">&quot;(Ljava/lang/String;)V&quot;</span>);<br>        mw.visitInsn(RETURN);<br>        mw.visitMaxs(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br>        mw.visitEnd();  <br><br>        <span class="hljs-keyword">return</span> cw.toByteArray();  <br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.q.mat;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> org.objectweb.asm.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadAndListHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Opcodes</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Thread innerThread1;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Thread innerThread2;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SameContentWrapperContainerProxy sameContentWrapperContainerProxy = <span class="hljs-keyword">new</span> SameContentWrapperContainerProxy();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-comment">// 启用两个线程作为 GC Roots</span><br>        innerThread1 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                SameContentWrapperContainerProxy proxy = sameContentWrapperContainerProxy;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    System.exit(<span class="hljs-number">1</span>);<br>                &#125;<br>            &#125;<br>        &#125;);<br>        innerThread1.setName(<span class="hljs-string">&quot;ThreadAndListHolder-thread-1&quot;</span>);<br>        innerThread1.start();<br><br>        innerThread2 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                SameContentWrapperContainerProxy proxy = proxy = sameContentWrapperContainerProxy;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    System.exit(<span class="hljs-number">1</span>);<br>                &#125;<br>            &#125;<br>        &#125;);<br>        innerThread2.setName(<span class="hljs-string">&quot;ThreadAndListHolder-thread-2&quot;</span>);<br>        innerThread2.start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IntArrayListWrapper</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> ArrayList&lt;Integer&gt; list;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">IntArrayListWrapper</span><span class="hljs-params">(ArrayList&lt;Integer&gt; list, String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.list = list;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SameContentWrapperContainer</span> </span>&#123;<br>    <span class="hljs-comment">// 2个Wrapper内部指向同一个 ArrayList，方便学习 Dominator tree</span><br>    IntArrayListWrapper intArrayListWrapper1;<br>    IntArrayListWrapper intArrayListWrapper2;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 线程直接支配 arrayList，两个 IntArrayListWrapper 均不支配 arrayList，只能线程运行完回收</span><br>        ArrayList&lt;Integer&gt; arrayList = generateSeqIntList(<span class="hljs-number">10</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>, <span class="hljs-number">0</span>);<br>        intArrayListWrapper1 = <span class="hljs-keyword">new</span> IntArrayListWrapper(arrayList, <span class="hljs-string">&quot;IntArrayListWrapper-1&quot;</span>);<br>        intArrayListWrapper2 = <span class="hljs-keyword">new</span> IntArrayListWrapper(arrayList, <span class="hljs-string">&quot;IntArrayListWrapper-2&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ArrayList&lt;Integer&gt; <span class="hljs-title">generateSeqIntList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> size, <span class="hljs-keyword">int</span> startValue)</span> </span>&#123;<br>        ArrayList&lt;Integer&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;(size);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = startValue; i &lt; startValue + size; i++) &#123;<br>            list.add(i);<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SameContentWrapperContainerProxy</span> </span>&#123;<br>    SameContentWrapperContainer sameContentWrapperContainer;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SameContentWrapperContainerProxy</span><span class="hljs-params">()</span> </span>&#123;<br>        SameContentWrapperContainer container = <span class="hljs-keyword">new</span> SameContentWrapperContainer();<br>        container.init();<br>        sameContentWrapperContainer = container;<br>    &#125;<br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">启动参数：-Xmx512m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="hljs-regexp">/Users/g</span>jd<span class="hljs-regexp">/Desktop/</span><span class="hljs-keyword">dump</span>/heapdump.hprof <br>-XX:-UseCompressedClassPointers -XX:-UseCompressedOops<br>复制代码<br></code></pre></td></tr></table></figure>

<p><strong>引用关系图</strong> <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c3d2e9807374c608857ae03ddb42709~tplv-k3u1fbpfcp-watermark.image"></p>
<p><strong>分析过程</strong></p>
<ol>
<li>首先进入 Dominator tree，可以看出是 SameContentWrapperContainerProxy 对象与 main 线程两者持有99%内存不能释放导致 OOM。 <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fe24e47a05042b7b61a103e3c7dbf4b~tplv-k3u1fbpfcp-watermark.image"><br>  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d953a502fdf40c6ad95a5a992ec33fb~tplv-k3u1fbpfcp-watermark.image"></li>
<li>先来看方向一，在 Heap Dump Overview 中可以快速定位到 Number of class loaders 数达50万以上，这种基本属于异常情况，如下图所示。 <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc64b31b8e484ca88e02590b42f82c74~tplv-k3u1fbpfcp-watermark.image"></li>
<li>使用 Class Loader Explorer 分析工具，此时会展现类加载详情，可以看到有524061个 class loader。我们的案例中仅有ClassLoaderOOMOps 这样的自定义类加载器，所以很快可以定位到问题。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf60312fd4894df98ccd7573a1c0c5c6~tplv-k3u1fbpfcp-watermark.image"><br>  <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9309e3ecfa4e48dc8b98ab2f1e4e08d6~tplv-k3u1fbpfcp-watermark.image"></li>
<li>如果类加载器较多，不能确定是哪个引发问题，则可以将所有的 class loader对象按类做聚类，如下图所示。 <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3dad1e14bad84ced8f906bf162dad4c5~tplv-k3u1fbpfcp-watermark.image"></li>
<li>Histogram 会根据 class 聚合，并展现对象数量级其 Shallow Heap 及 Retained Heap（如Retained Heap项目为空，可以点击下图中计算机的图标并计算 Retained Heap），可以看到 ClassLoaderOOMOps 有524044个对象，其 Retain Heap 占据了370M以上（上述代码是100M左右）。 <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09f7a1ecbe1d495cb144c16f676f9888~tplv-k3u1fbpfcp-watermark.image"></li>
<li>使用 incoming references，可以找到创建的代码位置。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8128a34a4fb42a7a28d4f7c69313e12~tplv-k3u1fbpfcp-watermark.image"></li>
<li>再来看方向二，同样在占据319M内存的 Obejct 数组采用 incoming references 查看引用路径，也很容易定位到具体代码位置。并且从下图中我们看出，Dominator tree 的起点并不一定是 GC根，且通过 Dominator tree 可能无法获取到最开始的创建路径，但 incoming references 是可以的。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64fac354fd204b3f93c43d48a25c0646~tplv-k3u1fbpfcp-watermark.image"></li>
</ol>
<h2 id="3-1-References"><a href="#3-1-References" class="headerlink" title="3.1 References"></a>3.1 References</h2><p><em><strong>注：笔者使用频率 Top2</strong></em></p>
<p><strong>功能</strong>：在对象引用图中查看某个特定对象的所有引用关系（提供对象对其他对象或基本类型的引用关系，以及被外部其他对象的引用关系）。通过任一对象的直接引用及间接引用详情（主要是属性值及内存占用），提供完善的依赖链路详情。</p>
<p><strong>使用入口</strong>：目标域右键 → List objects → with outgoing references/with incoming references.</p>
<p><strong>使用场景</strong></p>
<ul>
<li>  outgoing reference：查看对象所引用的对象，并支持链式传递操作。如查看一个大对象持有哪些内容，当一个复杂对象的 Retained Heap 较大时，通过 outgoing reference 可以查看由哪个属性引发。下图中 A 支配 F，且 F 占据大量内存，但优化时 F 的直接支配对象 A 无法修改。可通过 outgoing reference 看关系链上 D、B、E、C，并结合业务逻辑优化中间环节，这依托 dominator tree 是做不到的。</li>
<li>  incoming reference：查看对象被哪些对象引用，并支持链式传递操作。如查看一个大对象都被哪些对象引用，下图中 K 占内存大，所以 J 的 Retained Heap 较大，目标是从 GC Roots 摘除 J 引用，但在 Dominator tree 上 J 是树根，无法获取其被引用路径，可通过 incoming reference 查看关系链上的 H、X、Y ，并结合业务逻辑将 J 从 GC Root 链摘除。</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bde68d299620415cb34f5d6cbbeeeae7~tplv-k3u1fbpfcp-watermark.image"></p>
<h2 id="3-2-Thread-overview"><a href="#3-2-Thread-overview" class="headerlink" title="3.2 Thread overview"></a>3.2 Thread overview</h2><p><strong>功能</strong>：展现转储 dump 文件时线程执行栈、线程栈引用的对象等详细状态，也提供各线程的 Retained Heap 等关联内存信息。</p>
<p><strong>使用入口</strong>：MAT 主页 → Thread overview</p>
<p><strong>使用场景</strong></p>
<ul>
<li>  查看不同线程持有的内存占比，定位高内存消耗线程（开发技巧：不要直接使用 Thread 或 Executor 默认线程名避免全部混合在一起，使用线程尽量自命名方便识别，如下图中 ThreadAndListHolder-thread 是自定义线程名，可以很容易定位到具体代码）</li>
<li>查看线程的执行栈及变量，结合业务代码了解线程阻塞在什么地方，以及无法继续运行释放内存，如下图中 ThreadAndListHolder-thread 阻塞在 sleep 方法。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfcded48fb234e0682bdc6d872f03717~tplv-k3u1fbpfcp-watermark.image"></li>
</ul>
<h2 id="3-3-Path-To-GC-Roots"><a href="#3-3-Path-To-GC-Roots" class="headerlink" title="3.3 Path To GC Roots"></a>3.3 Path To GC Roots</h2><p><strong>功能</strong>：提供任一对象到 GC Root 的路径详情。</p>
<p><strong>使用入口</strong>：目标域右键 → Path To GC Roots</p>
<p><strong>使用场景</strong>：有时你确信已经处理了大的对象集合但依然无法回收，该功能能快速定位异常对象不能被 GC 回收的原因，直击异常对象到 GC Root 的引用路径。比 incoming reference 的优势是屏蔽掉很多不需关注的引用关系，比 Dominator tree 的优势是可以得到更全面的信息。</p>
<p><em>小技巧：在排查内存泄漏时，建议选择 exclude all phantom/weak/soft etc.references 排除虚引用/弱引用/软引用等的引用链，因为被虚引用/弱引用/软引用的对象可以直接被 GC 给回收，聚焦在对象否还存在 Strong 引用链即可。</em></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3919a0973e6f4ac0b4fe3460e24fec75~tplv-k3u1fbpfcp-watermark.image"></p>
<h2 id="3-4-class-loader-分析"><a href="#3-4-class-loader-分析" class="headerlink" title="3.4 class loader 分析"></a>3.4 class loader 分析</h2><p><strong>功能</strong></p>
<ul>
<li>  查看堆中所有 class loader 的使用情况（入口：MAT 主页菜单蓝色桶图标 → Java Basics → Class Loader Explorer）。</li>
<li>  查看堆中被不同class loader 重复加载的类（入口：MAT 主页菜单蓝色桶图标 → Java Basics → Duplicated Classes）。</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>  当从 Heap dump overview 了解到系统中 class loader 过多，导致占用内存异常时进入更细致的分析定位根因时使用。</li>
<li>  解决 NoClassDefFoundError 问题或检测 jar 包是否被重复加载</li>
</ul>
<p>具体使用方法在 2.6 及 3.5 两节的案例中有介绍。</p>
<h2 id="3-5-综合案例二"><a href="#3-5-综合案例二" class="headerlink" title="3.5 综合案例二"></a>3.5 综合案例二</h2><p><strong>使用工具项</strong>：class loader（重复类检测）、inspector、正则检索。</p>
<p><strong>异常现象</strong> ：运行时报 NoClassDefFoundError，在 classpath 中有两个不同版本的同名类。</p>
<p><strong>分析过程</strong></p>
<ol>
<li>进入 MAT 已加载的重复类检测功能，方式如下图。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60fbe324fe9d416c90c2e659b4f971c7~tplv-k3u1fbpfcp-watermark.image"></li>
<li>可以看到所有重复的类，以及相关的类加载器，如下图。 <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cdae3fc7b614c01a8047e3c024b4680~tplv-k3u1fbpfcp-watermark.image"></li>
<li>根据类名，在<code>&lt;Regex&gt;</code>框中输入类名可以过滤无效信息。</li>
<li>选中目标类，通过Inspector视图，可以看到被加载的类具体是在哪个jar包里。（本例中重复的类是被 URLClassloader 加载的，右键点击 “_context” 属性，最后点击 “Go Into”，在弹出的窗口中的属性 “_war” 值是被加载类的具体包位置） <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db89543ca6b544cf8e36252aa08a60be~tplv-k3u1fbpfcp-watermark.image"><br>  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3be497af48b4c5b9ea96b2ae2a9c967~tplv-k3u1fbpfcp-watermark.image"></li>
</ol>
<h2 id="4-1-inspector"><a href="#4-1-inspector" class="headerlink" title="4.1 inspector"></a>4.1 inspector</h2><p><strong>功能</strong>：MAT 通过 inspector 面板展现对象的详情信息，如静态属性值及实例属性值、内存地址、类继承关系、package、class loader、GC Roots 等详情数据。</p>
<p><strong>使用场景</strong></p>
<ul>
<li>  当内存使用量与业务逻辑有较强关联的场景，通过 inspector 可以通过查看对象具体属性值。比如：社交场景中某个用户对象的好友列表异常，其 List 长度达到几亿，通过 inspector 面板获取到异常用户 ID，进而从业务视角继续排查属于哪个用户，本例可能有系统账号，与所有用户是好友。</li>
<li>  集合等类型的使用会较多，如查看 ArrayList 的 size 属性也就了解其大小。</li>
</ul>
<p><strong>举例</strong>：下图中左边的 Inspector 窗口展现了地址 0x125754cf8 的 ArrayList 实例详情，包括 modCount 等并不会在 outgoing references 展现的基本属性。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5067f8c3bc94397ad829ae9ee882b34~tplv-k3u1fbpfcp-watermark.image"></p>
<h2 id="4-2-集合状态"><a href="#4-2-集合状态" class="headerlink" title="4.2 集合状态"></a>4.2 集合状态</h2><p><strong>功能</strong>：帮助更直观的了解系统的内存使用情况，查找浪费的内存空间。</p>
<p><strong>使用入口</strong>：MAT 主页 → Java Collections → 填充率/Hash冲突等功能。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/409f4fd84bef43dfabdd9f6337615917~tplv-k3u1fbpfcp-watermark.image"></p>
<p><strong>使用场景</strong></p>
<ul>
<li>  通过对 ArrayList 或数组等集合类对象按填充率聚类，定位稀疏或空集合类对象造成的内存浪费。</li>
<li>  通过 HashMap 冲突率判定 hash 策略是否合理。</li>
</ul>
<p>具体使用方法在 4.3 节案例详细介绍。</p>
<h2 id="4-3-综合案例三"><a href="#4-3-综合案例三" class="headerlink" title="4.3 综合案例三"></a>4.3 综合案例三</h2><p><strong>使用工具项</strong>：Dominator tree、Histogram、集合 ratio。</p>
<p><strong>异常现象</strong> ：程序 OOM，且 Dominator tree 无大对象，通过 Histogram 了解到多个 ArrayList 占据大量内存，期望通过减少 ArrayList 优化程序。</p>
<p><strong>程序代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.q.mat;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListRatioDemo</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10000</span>;i++)&#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                    HolderContainer holderContainer1 = <span class="hljs-keyword">new</span> HolderContainer();<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        Thread.sleep(<span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">60</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        System.exit(<span class="hljs-number">1</span>);<br>                    &#125;<br>                &#125;<br>            &#125;);<br>            thread.setName(<span class="hljs-string">&quot;inner-thread-&quot;</span> + i);<br>            thread.start();<br>        &#125;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HolderContainer</span> </span>&#123;<br>    ListHolder listHolder1 = <span class="hljs-keyword">new</span> ListHolder().init();<br>    ListHolder listHolder2 = <span class="hljs-keyword">new</span> ListHolder().init();<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListHolder</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> LIST_SIZE = <span class="hljs-number">100</span> * <span class="hljs-number">1000</span>;<br>    List&lt;String&gt; list1 = <span class="hljs-keyword">new</span> ArrayList(LIST_SIZE); <br>    List&lt;String&gt; list2 = <span class="hljs-keyword">new</span> ArrayList(LIST_SIZE); <br>    List&lt;String&gt; list3 = <span class="hljs-keyword">new</span> ArrayList(LIST_SIZE); <br>    List&lt;String&gt; list4 = <span class="hljs-keyword">new</span> ArrayList(LIST_SIZE); <br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ListHolder <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; LIST_SIZE; i++) &#123;<br>            <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0.05</span> * LIST_SIZE) &#123;<br>                list1.add(<span class="hljs-string">&quot;&quot;</span> + i);<br>                list2.add(<span class="hljs-string">&quot;&quot;</span> + i);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0.15</span> * LIST_SIZE) &#123;<br>                list3.add(<span class="hljs-string">&quot;&quot;</span> + i);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0.3</span> * LIST_SIZE) &#123;<br>                list4.add(<span class="hljs-string">&quot;&quot;</span> + i);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>分析过程</strong></p>
<ol>
<li>使用 Dominator tree 查看并无高占比起点。 <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2f44f9216f94b08bc3bdf7107d5a737~tplv-k3u1fbpfcp-watermark.image"></li>
<li>使用 Histogram 定位到 ListHolder 及 ArrayList 占比过高，经过业务分析很多 List 填充率很低浪费内存。 <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de3c98f88cf14561ae1117e2f8e55cd2~tplv-k3u1fbpfcp-watermark.image"></li>
<li>查看 ArrayList 的填充率，MAT 首页 → Java Collections → Collection Fill Ratio。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44000e6e5c2946e18ed1703d68aec244~tplv-k3u1fbpfcp-watermark.image"></li>
<li>查看类型填写 java.util.ArrayList。 <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad7db951d8254ebaa9c85f07e799f887~tplv-k3u1fbpfcp-watermark.image"></li>
<li>从结果可以看出绝大部分 ArrayList 初始申请长度过大。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fe6c558fd665443c874d41c920a64018~tplv-k3u1fbpfcp-watermark.image"></li>
</ol>
<h2 id="5-1-OQL"><a href="#5-1-OQL" class="headerlink" title="5.1 OQL"></a>5.1 OQL</h2><p><strong>功能</strong>：提供一种类似于SQL的对象（类）级别统一结构化查询语言，根据条件对堆中对象进行筛选。</p>
<p><strong>语法</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> [ INSTANCEOF ] <span class="hljs-operator">&lt;</span>class_name<span class="hljs-operator">&gt;</span> [ <span class="hljs-keyword">WHERE</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">filter</span><span class="hljs-operator">-</span>expression<span class="hljs-operator">&gt;</span> ]<br></code></pre></td></tr></table></figure>

<ul>
<li>  Select 子句可以使用“*”，查看结果对象的引用实例（相当于 outgoing references）；可以指定具体的内容，如 Select OBJECTS v.elementData from xx 是返回的结果是完整的对象，而不是简单的对象描述信息)；可以使用 Distinct 关键词去重。</li>
<li>  From 指定查询范围，一般指定类名、正则表达式、对象地址。</li>
<li>  Where 用来指定筛选条件。</li>
<li>  全部语法详见：<a href="https://link.juejin.cn/?target=https://help.eclipse.org/neon/index.jsp?topic=%252Forg.eclipse.mat.ui.help%252Freference%252Foqlsyntax.html" title="https://help.eclipse.org/neon/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Freference%2Foqlsyntax.html">OQL 语法</a></li>
<li>  未支持的核心功能：group by value，如果有需求可以先导出结果到 csv 中，再使用 awk 等脚本工具分析即可。</li>
<li>  <strong>例子</strong>：查找 size＝0 且未使用过的 ArrayList：select * from java.util.ArrayList where size=0 and modCount=0。</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>  一般比较复杂的问题会使用 OQL，而且这类问题往往与业务逻辑有较大关系。比如大量的小对象整体占用内存高，但预期小对象应该不会过多（比如达到百万个），一个一个看又不现实，可以采用 OQL 查询导出数据排查。</li>
<li>  <strong>例子</strong>：微服务的分布式链路追踪系统，采集各服务所有接口名，共计200个服务却采集到了200万个接口名（一个服务不会有1万个接口），这时直接在 List 中一个个查看很难定位，可以直接用 OQL 导出，定位哪个服务接口名收集异常（如把 URL 中 ID 也统计到接口中了）</li>
</ul>
<h2 id="5-2-检索及筛选"><a href="#5-2-检索及筛选" class="headerlink" title="5.2 检索及筛选"></a>5.2 检索及筛选</h2><p><strong>功能</strong>：本文第二章内存分布，第三章对象间依赖的众多功能，均支持按字符串检索、按正则检索等操作。</p>
<p><strong>使用场景</strong>：在使用 Histogram、Thread overview 等功能时，可以进一步添加字符串匹配、正则匹配条件过滤缩小排查范围。</p>
<h2 id="5-3-按地址寻址"><a href="#5-3-按地址寻址" class="headerlink" title="5.3 按地址寻址"></a>5.3 按地址寻址</h2><p><strong>功能</strong>：根据对象的虚拟内存十六进制地址查找对象。</p>
<p><strong>使用场景</strong>：仅知道地址并希望快速查看对象做后续分析时使用，其余可以直接使用 outgoing reference 了解对象信息。</p>
<h2 id="5-4-综合案例四"><a href="#5-4-综合案例四" class="headerlink" title="5.4 综合案例四"></a>5.4 综合案例四</h2><p><strong>使用工具项</strong>：OQL、Histogram、incoming references</p>
<p><strong>异常现象及目的</strong> ：程序占用内存高，存在默认初始化较长的 ArrayList，需分析 ArrayList 被使用的占比，通过数据支撑是否采用懒加载模式，并分析具体哪块代码创建了空 ArrayList。</p>
<p><strong>程序代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmptyListDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        EmptyValueContainerList emptyValueContainerList = <span class="hljs-keyword">new</span> EmptyValueContainerList();<br>        FilledValueContainerList filledValueContainerList = <span class="hljs-keyword">new</span> FilledValueContainerList();<br>        System.out.println(<span class="hljs-string">&quot;start sleep...&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">50</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.exit(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmptyValueContainer</span> </span>&#123;<br>    List&lt;Integer&gt; value1 = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">10</span>);<br>    List&lt;Integer&gt; value2 = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">10</span>);<br>    List&lt;Integer&gt; value3 = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">10</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmptyValueContainerList</span> </span>&#123;<br>    List&lt;EmptyValueContainer&gt; list = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">500</span> * <span class="hljs-number">1000</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EmptyValueContainerList</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">500</span> * <span class="hljs-number">1000</span>; i++) &#123;<br>            list.add(<span class="hljs-keyword">new</span> EmptyValueContainer());<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilledValueContainer</span> </span>&#123;<br>    List&lt;Integer&gt; value1 = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">10</span>);<br>    List&lt;Integer&gt; value2 = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">10</span>);<br>    List&lt;Integer&gt; value3 = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> FilledValueContainer <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        value1.addAll(Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>));<br>        value2.addAll(Arrays.asList(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>));<br>        value1.addAll(Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilledValueContainerList</span> </span>&#123;<br>    List&lt;FilledValueContainer&gt; list = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">500</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FilledValueContainerList</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">500</span>; i++) &#123;<br>            list.add(<span class="hljs-keyword">new</span> FilledValueContainer().init());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>分析过程</strong></p>
<ol>
<li>内存中有50万个 capacity = 10 的空 ArrayList 实例。我们分析下这些对象的占用内存总大小及对象创建位置，以便分析延迟初始化（即直到使用这些对象的时候才将之实例化，否则一直为null）是否有必要。</li>
<li>使用 OQL 查询出初始化后未被使用的 ArrayList（size=0 且 modCount=0），语句如下图。可以看出公有 150 万个空 ArrayList，这些对象属于浪费内存。我们接下来计算下总计占用多少内存，并根据结果看是否需要优化。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef6b45a0681c4976a0fd59ba31de6243~tplv-k3u1fbpfcp-watermark.image"></li>
<li>计算 150万 ArrayList占内存总量，直接点击右上方带黄色箭头的 Histogram 图标，这个图标是在选定的结果再用直方图展示，总计支配了120M 左右内存（所以这里点击结果，不包含 modCount 或 size 大于0的 ArrayList 对象）。<strong>这类在选定结果继续分析很多功能都支持，如正则检索、Histogram、Dominator tree等等。</strong>  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99960e293cf742b3b60f90095d2c56f8~tplv-k3u1fbpfcp-watermark.image"></li>
<li>查看下空 ArrayList 的具体来源，可用 incoming references，下图中显示了清晰的对象创建路径。 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffe93f29a7cc499795279070ed3edb25~tplv-k3u1fbpfcp-watermark.image"></li>
</ol>
<p>至此本文讲解了 MAT 各项工具的功能、使用方法、适用场景，也穿插了4个实战案例，熟练掌握对分析 JVM 内存问题大有裨益，尤其是各种功能的组合使用。在下一篇《JVM 内存分析工具 MAT 的深度讲解与实践——高阶篇》会总结 JVM 堆内存分析的系统性方法，并在更复杂的案例中实践。</p>
<ul>
<li>  <a href="https://link.juejin.cn/?target=https://help.eclipse.org/2020-09/index.jsp?topic=/org.eclipse.mat.ui.help/welcome.html" title="https://help.eclipse.org/2020-09/index.jsp?topic=/org.eclipse.mat.ui.help/welcome.html">MAT官网</a></li>
<li>  <a href="https://link.juejin.cn/?target=https://eclipsesource.com/blogs/2013/01/21/10-tips-for-using-the-eclipse-memory-analyzer/" title="https://eclipsesource.com/blogs/2013/01/21/10-tips-for-using-the-eclipse-memory-analyzer/">10 Tips for using the Eclipse Memory Analyzer</a></li>
<li>  <a href="https://link.juejin.cn/?target=https://blogs.sap.com/2007/07/02/finding-memory-leaks-with-sap-memory-analyzer/" title="https://blogs.sap.com/2007/07/02/finding-memory-leaks-with-sap-memory-analyzer/">Finding Memory Leaks with SAP Memory Analyzer</a></li>
<li>  <a href="https://link.juejin.cn/?target=https://community.bonitasoft.com/blog/effective-way-fight-duplicated-libs-and-version-conflicting-classes-using-memory-analyzer-tool" title="https://community.bonitasoft.com/blog/effective-way-fight-duplicated-libs-and-version-conflicting-classes-using-memory-analyzer-tool">An effective way to fight duplicated libs and version conflicting classes using Memory Analyzer Tool</a></li>
<li>  <a href="https://link.juejin.cn/?target=https://blogs.sap.com/2007/08/02/memory-for-nothing/" title="https://blogs.sap.com/2007/08/02/memory-for-nothing/">Memory for nothing（Empty collection problem）</a></li>
</ul>

  </article>

  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/JVM-%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90/">JVM 内存分析</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/JVM/" rel="tag">JVM</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/MAT/" rel="tag">MAT</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'f3372034aa4218f9f359',
        clientSecret: '235d14468b5af5837a9ff5e7b7541e93070cf602',
        id: window.location.pathname,
        repo: 'code-13.github.io',
        owner: 'code-13',
        admin: 'code-13'
    })
    gitalk.render('gitalk')
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%85%A8%E5%B1%80%E4%BF%A1%E6%81%AF%E6%A6%82%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">2.1 全局信息概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Dominator-tree"><span class="toc-number">2.</span> <span class="toc-text">2.2 Dominator tree</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Histogram-%E7%9B%B4%E6%96%B9%E5%9B%BE"><span class="toc-number">3.</span> <span class="toc-text">2.3 Histogram 直方图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Leak-Suspects"><span class="toc-number">4.</span> <span class="toc-text">2.4 Leak Suspects</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-Top-Consumers"><span class="toc-number">5.</span> <span class="toc-text">2.5 Top Consumers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="toc-number">6.</span> <span class="toc-text">2.6 综合案例一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-References"><span class="toc-number">7.</span> <span class="toc-text">3.1 References</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Thread-overview"><span class="toc-number">8.</span> <span class="toc-text">3.2 Thread overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Path-To-GC-Roots"><span class="toc-number">9.</span> <span class="toc-text">3.3 Path To GC Roots</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-class-loader-%E5%88%86%E6%9E%90"><span class="toc-number">10.</span> <span class="toc-text">3.4 class loader 分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B%E4%BA%8C"><span class="toc-number">11.</span> <span class="toc-text">3.5 综合案例二</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-inspector"><span class="toc-number">12.</span> <span class="toc-text">4.1 inspector</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E9%9B%86%E5%90%88%E7%8A%B6%E6%80%81"><span class="toc-number">13.</span> <span class="toc-text">4.2 集合状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B%E4%B8%89"><span class="toc-number">14.</span> <span class="toc-text">4.3 综合案例三</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-OQL"><span class="toc-number">15.</span> <span class="toc-text">5.1 OQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%A3%80%E7%B4%A2%E5%8F%8A%E7%AD%9B%E9%80%89"><span class="toc-number">16.</span> <span class="toc-text">5.2 检索及筛选</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%8C%89%E5%9C%B0%E5%9D%80%E5%AF%BB%E5%9D%80"><span class="toc-number">17.</span> <span class="toc-text">5.3 按地址寻址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B%E5%9B%9B"><span class="toc-number">18.</span> <span class="toc-text">5.4 综合案例四</span></a></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1640337216943"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
